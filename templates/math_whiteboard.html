{% extends "base.html" %} {% block content %}
<div class="container mt-4">
  <h2>Math Whiteboard</h2>
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <div class="btn-toolbar" role="toolbar">
            <div class="btn-group mr-2" role="group">
              <button id="pen-tool" class="btn btn-primary active">Pen</button>
              <button id="eraser-tool" class="btn btn-secondary">Eraser</button>
            </div>
            <div class="btn-group mr-2" role="group">
              <button id="clear-board" class="btn btn-danger">Clear</button>
            </div>
            <div class="btn-group" role="group">
              <input
                type="color"
                id="color-picker"
                value="#000000"
                title="Select color"
              />
            </div>
            <div class="btn-group ml-2" role="group">
              <input
                type="range"
                id="brush-size"
                min="1"
                max="20"
                value="3"
                title="Brush size"
              />
            </div>
          </div>
        </div>
        <div class="card-body">
          <canvas
            id="whiteboard"
            width="800"
            height="500"
            style="border: 1px solid #ccc; background-color: white"
          ></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">Math Tools</div>
        <div class="card-body">
          <div class="btn-group-vertical w-100" role="group">
            <button
              class="btn btn-outline-secondary math-tool"
              data-tool="line"
            >
              Line
            </button>
            <button
              class="btn btn-outline-secondary math-tool"
              data-tool="circle"
            >
              Circle
            </button>
            <button
              class="btn btn-outline-secondary math-tool"
              data-tool="rectangle"
            >
              Rectangle
            </button>
            <button
              class="btn btn-outline-secondary math-tool"
              data-tool="triangle"
            >
              Triangle
            </button>
            <button
              class="btn btn-outline-secondary math-tool"
              data-tool="text"
            >
              Add Text
            </button>
            <button
              class="btn btn-outline-secondary math-tool"
              data-tool="latex"
            >
              LaTeX Equation
            </button>
          </div>

          <div id="latex-input" class="mt-3" style="display: none">
            <textarea
              id="latex-equation"
              class="form-control mb-2"
              placeholder="Enter LaTeX equation"
            ></textarea>
            <button id="insert-latex" class="btn btn-primary">Insert</button>
          </div>

          <div id="text-input" class="mt-3" style="display: none">
            <input
              type="text"
              id="text-content"
              class="form-control mb-2"
              placeholder="Enter text"
            />
            <button id="insert-text" class="btn btn-primary">Insert</button>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header">Participants</div>
        <div class="card-body">
          <ul id="participants-list" class="list-group">
            <!-- Participants will be added here via JavaScript -->
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include MathJax for LaTeX rendering -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
></script>

<script>
  // Whiteboard JavaScript will go here
  document.addEventListener("DOMContentLoaded", function () {
    const canvas = document.getElementById("whiteboard");
    const ctx = canvas.getContext("2d");
    let isDrawing = false;
    let currentTool = "pen";
    let currentColor = "#000000";
    let brushSize = 3;
    let startX, startY;
    let tempElement = null;

    // Set canvas background to white
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Tool buttons
    document.getElementById("pen-tool").addEventListener("click", function () {
      currentTool = "pen";
      this.classList.add("active");
      document.getElementById("eraser-tool").classList.remove("active");
    });

    document
      .getElementById("eraser-tool")
      .addEventListener("click", function () {
        currentTool = "eraser";
        this.classList.add("active");
        document.getElementById("pen-tool").classList.remove("active");
      });

    document
      .getElementById("clear-board")
      .addEventListener("click", function () {
        if (confirm("Are you sure you want to clear the whiteboard?")) {
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
      });

    document
      .getElementById("color-picker")
      .addEventListener("input", function () {
        currentColor = this.value;
      });

    document
      .getElementById("brush-size")
      .addEventListener("input", function () {
        brushSize = this.value;
      });

    // Math tools
    document.querySelectorAll(".math-tool").forEach((button) => {
      button.addEventListener("click", function () {
        currentTool = this.dataset.tool;

        // Hide all input panels
        document.getElementById("latex-input").style.display = "none";
        document.getElementById("text-input").style.display = "none";

        // Show relevant input panel
        if (currentTool === "latex") {
          document.getElementById("latex-input").style.display = "block";
        } else if (currentTool === "text") {
          document.getElementById("text-input").style.display = "block";
        }
      });
    });

    // Insert LaTeX equation
    document
      .getElementById("insert-latex")
      .addEventListener("click", function () {
        const equation = document.getElementById("latex-equation").value;
        if (equation) {
          // Create a div with the LaTeX equation
          const div = document.createElement("div");
          div.style.position = "absolute";
          div.style.left = canvas.width / 2 - 100 + "px";
          div.style.top = canvas.height / 2 - 50 + "px";
          div.style.width = "200px";
          div.innerHTML = `\\(${equation}\\)`;

          // Render the MathJax
          MathJax.typesetPromise([div]).then(() => {
            // Convert the div to an image and draw on canvas
            html2canvas(div).then((canvas) => {
              ctx.drawImage(
                canvas,
                canvas.width / 2 - 100,
                canvas.height / 2 - 50
              );
            });
          });

          document.getElementById("latex-equation").value = "";
          document.getElementById("latex-input").style.display = "none";
        }
      });

    // Insert text
    document
      .getElementById("insert-text")
      .addEventListener("click", function () {
        const text = document.getElementById("text-content").value;
        if (text) {
          ctx.font = `${brushSize * 5}px Arial`;
          ctx.fillStyle = currentColor;
          ctx.fillText(text, canvas.width / 2, canvas.height / 2);

          document.getElementById("text-content").value = "";
          document.getElementById("text-input").style.display = "none";
        }
      });

    // Drawing functionality
    canvas.addEventListener("mousedown", startDrawing);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", stopDrawing);
    canvas.addEventListener("mouseout", stopDrawing);

    function startDrawing(e) {
      isDrawing = true;
      startX = e.offsetX;
      startY = e.offsetY;

      if (currentTool === "pen" || currentTool === "eraser") {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.strokeStyle = currentTool === "eraser" ? "white" : currentColor;
        ctx.lineWidth = brushSize;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
      }
    }

    function draw(e) {
      if (!isDrawing) return;

      if (currentTool === "pen" || currentTool === "eraser") {
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      } else if (currentTool === "line") {
        redrawCanvas();
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.stroke();
      } else if (currentTool === "circle") {
        redrawCanvas();
        const radius = Math.sqrt(
          Math.pow(e.offsetX - startX, 2) + Math.pow(e.offsetY - startY, 2)
        );
        ctx.beginPath();
        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.stroke();
      } else if (currentTool === "rectangle") {
        redrawCanvas();
        ctx.beginPath();
        ctx.rect(startX, startY, e.offsetX - startX, e.offsetY - startY);
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.stroke();
      } else if (currentTool === "triangle") {
        redrawCanvas();
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.lineTo(startX * 2 - e.offsetX, e.offsetY);
        ctx.closePath();
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.stroke();
      }
    }

    function stopDrawing() {
      isDrawing = false;

      // For shape tools, we want to keep the shape after drawing
      if (["line", "circle", "rectangle", "triangle"].includes(currentTool)) {
        // The shape is already on the canvas, nothing more to do
      }
    }

    function redrawCanvas() {
      // Create a temporary canvas to preserve the existing drawing
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext("2d");
      tempCtx.drawImage(canvas, 0, 0);

      // Clear the main canvas and redraw the saved image
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(tempCanvas, 0, 0);
    }

    // Add html2canvas library for LaTeX rendering
    const script = document.createElement("script");
    script.src = "https://html2canvas.hertzen.com/dist/html2canvas.min.js";
    document.head.appendChild(script);

    // Add Socket.IO for real-time collaboration
    const socketScript = document.createElement("script");
    socketScript.src = "https://cdn.socket.io/4.5.0/socket.io.min.js";
    document.head.appendChild(socketScript);

    // Initialize socket connection when the library is loaded
    socketScript.onload = function () {
      const socket = io();

      // When connected, send user info
      socket.on("connect", function () {
        const username = "{{ session.username|default('Anonymous') }}";
        socket.emit("join whiteboard", { username });
      });

      // Update participants list
      socket.on("update participants", function (participants) {
        const list = document.getElementById("participants-list");
        list.innerHTML = "";

        participants.forEach((participant) => {
          const item = document.createElement("li");
          item.className = "list-group-item";
          item.textContent = participant.username;
          list.appendChild(item);
        });
      });

      // Handle drawing data from other users
      socket.on("drawing", function (data) {
        // Implement drawing from other users
        // This would mirror the drawing functions above
      });
    };
  });
</script>

<style>
  #whiteboard {
    cursor: crosshair;
    touch-action: none; /* Prevent scrolling on touch devices */
  }

  .btn-toolbar .btn-group {
    margin-right: 5px;
  }

  .math-tool.active {
    background-color: #007bff;
    color: white;
  }
</style>
{% endblock %}
