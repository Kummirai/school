{% extends "base.html" %} {% block title %}Educational Game Hub{% endblock %} {%
block content %}
<style>
  .grade-card {
    transition: transform 0.3s, box-shadow 0.3s;
    margin-bottom: 20px;
    min-height: 200px;
  }
  .grade-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }
  .player-selector {
    background-color: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
  }
  .game-card {
    cursor: pointer;
    transition: all 0.3s;
  }
  .game-card:hover {
    background-color: #f1f8ff;
  }
  .subject-badge {
    font-size: 0.8rem;
    margin-right: 5px;
  }
  .player-icon {
    width: 30px;
    height: 30px;
    margin-right: 5px;
  }
</style>

<div class="container py-5">
  <div class="text-center mb-5">
    <h1 class="display-4">Educational Game Hub</h1>
    <p class="lead">
      Select your grade level and number of players to start playing!
    </p>
  </div>

  <!-- Player Selection -->
  <div class="player-selector">
    <h3 class="mb-4">How many players?</h3>
    <div class="d-flex flex-wrap justify-content-center">
      {% for i in range(1, 9) %}
      <button
        class="btn btn-outline-primary m-2 player-btn"
        data-players="{{ i }}"
      >
        <img
          src="{{ url_for('static', filename='images/player_' + i|string + '.png') }}"
          alt="{{ i }} player"
          class="player-icon"
        />
        {{ i }} Player{% if i > 1 %}s{% endif %}
      </button>
      {% endfor %}
    </div>
  </div>

  <!-- Grade Selection -->
  <h3 class="mb-4">Select Grade Level:</h3>
  <div class="row">
    {% for grade in range(7, 13) %}
    <div class="col-md-4 mb-4">
      <div class="card grade-card h-100" id="grade-{{ grade }}">
        <div class="card-body text-center">
          <h2 class="card-title">Grade {{ grade }}</h2>
          <div class="game-list mt-3" style="display: none">
            <h5 class="mb-3">Available Games:</h5>
            <div class="list-group">
              <a
                href="#"
                class="list-group-item list-group-item-action game-card"
                data-game="math"
                data-grade="{{ grade }}"
              >
                <span class="badge bg-primary subject-badge">Math</span>
                Math Challenge
              </a>
              <a
                href="#"
                class="list-group-item list-group-item-action game-card"
                data-game="english"
                data-grade="{{ grade }}"
              >
                <span class="badge bg-success subject-badge">English</span>
                English Adventure
              </a>
              <a
                href="#"
                class="list-group-item list-group-item-action game-card"
                data-game="science"
                data-grade="{{ grade }}"
              >
                <span class="badge bg-danger subject-badge">Science</span>
                Science Explorer
              </a>
              <a
                href="#"
                class="list-group-item list-group-item-action game-card"
                data-game="history"
                data-grade="{{ grade }}"
              >
                <span class="badge bg-warning subject-badge">History</span>
                History Quest
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Game Launch Modal -->
<div class="modal fade" id="gameLaunchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="gameModalTitle">Ready to Play!</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          You've selected:
          <strong><span id="selectedGameName"></span></strong>
        </p>
        <p>
          Grade level: <strong><span id="selectedGrade"></span></strong>
        </p>
        <p>
          Number of players:
          <strong><span id="selectedPlayers"></span></strong>
        </p>

        <div class="mb-3" id="playerNamesInput" style="display: none">
          <h6>Enter Player Names:</h6>
          <div id="nameInputs"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="startGameBtn">
          Start Game
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Game configuration
  let currentConfig = {
    players: 1,
    grade: 7,
    game: "math",
    playerNames: [],
  };

  // Player selection
  document.querySelectorAll(".player-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      // Update active button styling
      document.querySelectorAll(".player-btn").forEach((b) => {
        b.classList.remove("btn-primary");
        b.classList.add("btn-outline-primary");
      });
      this.classList.remove("btn-outline-primary");
      this.classList.add("btn-primary");

      // Store player count
      currentConfig.players = parseInt(this.dataset.players);
    });
  });

  // Grade selection - show/hide game lists
  document.querySelectorAll(".grade-card").forEach((card) => {
    card.addEventListener("click", function () {
      // Hide all game lists first
      document.querySelectorAll(".game-list").forEach((list) => {
        list.style.display = "none";
      });

      // Show game list for this grade
      const gameList = this.querySelector(".game-list");
      gameList.style.display = "block";

      // Store grade level
      currentConfig.grade = parseInt(this.id.split("-")[1]);
    });
  });

  // Game selection
  document.querySelectorAll(".game-card").forEach((card) => {
    card.addEventListener("click", function (e) {
      e.preventDefault();
      currentConfig.game = this.dataset.game;

      // Update modal content
      document.getElementById("selectedGameName").textContent =
        this.textContent.trim();
      document.getElementById("selectedGrade").textContent =
        "Grade " + currentConfig.grade;
      document.getElementById("selectedPlayers").textContent =
        currentConfig.players +
        (currentConfig.players > 1 ? " Players" : " Player");

      // Handle player name input for multiplayer
      const nameInputs = document.getElementById("nameInputs");
      nameInputs.innerHTML = "";

      if (currentConfig.players > 1) {
        document.getElementById("playerNamesInput").style.display = "block";
        for (let i = 0; i < currentConfig.players; i++) {
          const div = document.createElement("div");
          div.className = "mb-2";
          div.innerHTML = `
                            <label class="form-label">Player ${
                              i + 1
                            } Name:</label>
                            <input type="text" class="form-control player-name" 
                                   placeholder="Enter name" required>
                        `;
          nameInputs.appendChild(div);
        }
      } else {
        document.getElementById("playerNamesInput").style.display = "none";
      }

      // Show modal
      const modal = new bootstrap.Modal(
        document.getElementById("gameLaunchModal")
      );
      modal.show();
    });
  });

  // Start game button
  document
    .getElementById("startGameBtn")
    .addEventListener("click", function () {
      // Collect player names if multiplayer
      if (currentConfig.players > 1) {
        currentConfig.playerNames = [];
        document.querySelectorAll(".player-name").forEach((input) => {
          currentConfig.playerNames.push(
            input.value || `Player ${currentConfig.playerNames.length + 1}`
          );
        });
      } else {
        currentConfig.playerNames = ["Player 1"];
      }

      // Close modal
      const modal = bootstrap.Modal.getInstance(
        document.getElementById("gameLaunchModal")
      );
      modal.hide();

      // Redirect to appropriate game with parameters
      launchGame();
    });

  function launchGame() {
    // Construct URL with query parameters
    const params = new URLSearchParams();
    params.append("grade", currentConfig.grade);
    params.append("players", currentConfig.players);
    currentConfig.playerNames.forEach((name, index) => {
      params.append(`player${index + 1}`, name);
    });

    // Determine which game to launch
    let gameUrl;
    switch (currentConfig.game) {
      case "math":
        gameUrl = "{{ url_for('gamehub.math_game') }}";
        break;
      case "english":
        gameUrl = "{{ url_for('gamehub.english_game') }}";
        break;
      case "science":
        gameUrl = "{{ url_for('gamehub.science_game') }}";
        break;
      case "history":
        gameUrl = "{{ url_for('gamehub.history_game') }}";
        break;
      default:
        gameUrl = "{{ url_for('gamehub.math_game') }}";
    }

    // Redirect to game with parameters
    window.location.href = `${gameUrl}?${params.toString()}`;
  }
</script>
{%endblock%}
