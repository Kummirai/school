{% extends "base.html" %}
{% block title %}{{ exam.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card mb-4 border-2 shadow-sm">
      <div class="card-header bg-dark text-white">
        <h2 class="card-title text-center mb-0 py-2 h4">{{ exam.subject }} - {{ exam.paper }}</h2>
      </div>
      <div class="card-body bg-light">
        <div class="row text-center">
          <div class="col-md-4">
            <strong class="text-muted">Grade:</strong><br> {{ exam.grade }}
          </div>
          <div class="col-md-4">
            <strong class="text-muted">Date:</strong><br> {{ exam.month }} {{ exam.year }}
          </div>
          <div class="col-md-4">
            <strong class="text-muted">Duration:</strong><br> {{ exam.duration_minutes }} minutes
          </div>
        </div>
      </div>
    </div>
    <div id="timer" class="alert alert-info fw-bold text-center fs-4">Time Remaining: <span id="countdown"></span></div>
    
    <form action="{{ url_for('exam.submit_exam', exam_id=exam.id) }}" method="POST">
        {% for section, section_questions in questions | groupby('section') %}
            <h2 class="mt-5 mb-3">Section {{ section }}</h2>
            {% for question in section_questions %}
                <div class="card mb-3">
                    <div class="card-header">
                        <strong style="color: #2F4F4F;">Question {{ question.number }}</strong>
                        {% if question.marks %}
                        <span class="badge bg-info float-end">{{ question.marks }} Marks</span>
                        {% elif question.points %}
                        <span class="badge bg-info float-end">{{ question.points }} Points</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if question.image_url %}
                        <img src="{{ question.image_url }}" class="img-fluid mb-3" alt="Question Image">
                        {% endif %}
                        
                        <p class="card-text">{{ question.question_text | safe }}</p>

                        <!-- Debug: Type={{ question.type }}, Options={{ question.options }} -->
                        {% if (question.type == 'mcq' or question.type == 'multiple_choice') and question.options %}
                            {# Multiple Choice #}
                            {% for option in question.options %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="option_{{ question.id }}_{{ loop.index }}" value="{{ option }}" required>
                                <label class="form-check-label" for="option_{{ question.id }}_{{ loop.index }}">
                                    {{ option }}
                                </label>
                            </div>
                            {% endfor %}
                        {% elif question.type == 'short' %}
                            {# Short Answer #}
                            <input type="text" name="question_{{ question.id }}" class="form-control" required>
                        {% elif question.type == 'essay' or question.type == 'text' %}
                            {# Essay #}
                            <textarea name="question_{{ question.id }}" class="form-control" rows="5" required></textarea>
                        {% elif question.type == 'matching' and question.options %}
                            {# Matching #}
                            <div class="row">
                                <div class="col-md-12">
                                    <p>Match the following:</p>
                                    {# Assuming each 'question' object is a single matching item #}
                                    <div class="input-group mb-2">
                                        <span class="input-group-text" style="width: 250px;">{{ question.question_text | safe }}</span>
                                        <select name="question_{{ question.id }}" class="form-select" required>
                                            <option value="">Select a match</option>
                                            {% for choice in question.options %}
                                            <option value="{{ choice }}">{{ choice }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
        
        <button type="submit" class="btn btn-primary mt-4">Submit Exam</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const countdownElement = document.getElementById('countdown');
    const examForm = document.querySelector('form');
    const durationMinutes = {{ exam.duration_minutes }};
    const examId = '{{ exam.id }}';
    const endTimeStorageKey = `examEndTime_${examId}`;

    let endTime = localStorage.getItem(endTimeStorageKey);

    if (!endTime) {
        endTime = Date.now() + durationMinutes * 60 * 1000;
        localStorage.setItem(endTimeStorageKey, endTime);
    }

    function updateCountdown() {
        const now = Date.now();
        const remainingTime = endTime - now;

        if (remainingTime <= 0) {
            countdownElement.textContent = 'Time is up!';
            clearInterval(timerInterval);
            localStorage.removeItem(endTimeStorageKey);
            examForm.submit();
            return;
        }

        const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

        countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    const timerInterval = setInterval(updateCountdown, 1000);
    updateCountdown();
});
</script>
{% endblock %}