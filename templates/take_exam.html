{% extends "base.html" %} {% block title %}Take Exam - {{ exam.title }}{%
endblock %} {% block content %}
<style>
  /* Include all CSS from view.html */
  .method {
    background: #f5f5f5;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
    border-left: 4px solid #007acc;
  }

  .example {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 4px;
    border: 1px solid #ddd;
  }

  .code {
    background: #2d3748;
    color: #e2e8f0;
    padding: 10px;
    border-radius: 4px;
    font-family: "Courier New", monospace;
    margin: 10px 0;
    overflow-x: auto;
  }

  /* Fraction styling */
  .fraction-css {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    vertical-align: middle;
    font-size: 0.9em;
    margin: 0 3px;
  }

  .fraction-css .numerator {
    border-bottom: 1px solid black;
    padding-bottom: 2px;
    text-align: center;
    min-width: 20px;
  }

  .fraction-css .denominator {
    padding-top: 2px;
    text-align: center;
    min-width: 20px;
  }

  /* Exponent styling */
  .exponent-css {
    font-size: 0.7em;
    vertical-align: super;
    line-height: 1;
  }

  /* Question styling */
  .question {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .question:hover {
    border-color: #007acc;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .question-number {
    background: #007acc;
    color: white;
    padding: 4px 8px;
    border-radius: 15px;
    font-size: 0.9em;
    font-weight: bold;
  }

  .marks-badge {
    background: #28a745;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8em;
    float: right;
  }

  /* Timer styling */
  .timer-container {
    background: #f8f9fa;
    border: 2px solid #dc3545;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    text-align: center;
  }

  .timer-display {
    font-size: 1.5em;
    font-weight: bold;
    color: #dc3545;
  }

  /* Progress bar */
  .progress-container {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    margin-bottom: 20px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #007acc, #0056b3);
    transition: width 0.3s ease;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .question {
      padding: 15px;
    }
  }

  /* Math symbol styling */
  .math-symbol {
    font-family: "Times New Roman", Times, serif;
    font-style: italic;
  }
</style>

<div class="container mt-4 mx-0">
  <!-- Exam Header -->
  <h1>{{ exam.title }}</h1>

  <!-- Exam Info -->
  <div class="row mb-3">
    <div class="col-md-6">
      <span class="badge bg-primary"
        >{{ exam.subject if exam.subject else 'General' }}</span
      >
      <span class="badge bg-info">Exam</span>
      <span class="badge bg-secondary"
        >{{ exam.difficulty if exam.difficulty else 'Standard' }}</span
      >
    </div>
    <div class="col-md-6 text-end">
      <span class="text-muted"
        >Duration: {{ exam.duration_minutes }} minutes</span
      >
      {% if exam.total_marks %}
      <span class="text-muted ms-2">Total Marks: {{ exam.total_marks }}</span>
      {% endif %}
    </div>
  </div>

  <!-- Description -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Exam Description</h5>
      <div class="card-text">{{ exam.description|safe }}</div>
    </div>
  </div>

  <!-- Timer -->
  <div class="timer-container">
    <h5 class="mb-2">Time Remaining</h5>
    <div id="timer" class="timer-display">{{ exam.duration_minutes }}:00</div>
  </div>

  <!-- Progress -->
  <div class="progress-container">
    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
  </div>
  <div class="text-center mb-4">
    <small class="text-muted"
      >Progress: <span id="progressText">0</span> of {{ exam.questions|length }}
      questions answered</small
    >
  </div>

  <!-- Exam Form -->
  <form
    id="examForm"
    action="{{ url_for('submit_exam', exam_id=exam.id) }}"
    method="POST"
  >
    {% for question in exam.questions %}
    <div class="question" data-question-id="{{ question.id }}">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <span class="question-number">Question {{ loop.index }}</span>
          {% if question.type %}
          <span class="badge bg-secondary ms-2"
            >{{ question.type|replace('_', ' ')|title }}</span
          >
          {% endif %}
        </div>
        {% if question.marks %}
        <span class="marks-badge"
          >{{ question.marks }} mark{% if question.marks > 1 %}s{% endif
          %}</span
        >
        {% endif %}
      </div>

      <div class="question-text mb-3">
        {# Handle different question text fields from different exam formats #}
        {% if question.text %} {{ question.text|safe }} {% elif
        question.question %} {{ question.question|safe }} {% else %} Question
        content not available {% endif %}
      </div>

      {# Handle different question types and formats #} {% if question.options
      %} {# Multiple choice questions #}
      <div class="options-container">
        {% for option in question.options %}
        <div class="form-check">
          <input
            class="form-check-input question-input"
            type="radio"
            name="question_{{ question.id }}"
            id="option_{{ question.id }}_{{ loop.index }}"
            value="{{ option }}"
            required
          />
          <label
            class="form-check-label"
            for="option_{{ question.id }}_{{ loop.index }}"
          >
            {{ option|safe }}
          </label>
        </div>
        {% endfor %}
      </div>

      {% elif question.type == 'short_answer' or question.type == 'text_input'
      %} {# Short answer questions #}
      <div class="answer-container">
        <textarea
          class="form-control question-input"
          name="question_{{ question.id }}"
          rows="3"
          placeholder="Enter your answer here..."
          required
        ></textarea>
      </div>

      {% elif question.type == 'problem_solving' or question.type == 'proof' %}
      {# Problem solving questions with more space #}
      <div class="answer-container">
        <textarea
          class="form-control question-input"
          name="question_{{ question.id }}"
          rows="5"
          placeholder="Show your work and provide the final answer..."
          required
        ></textarea>
      </div>

      {% else %} {# Fallback for any other question type #}
      <div class="alert alert-warning">
        This question type is not fully supported. Please write your answer
        below.
      </div>
      <div class="answer-container">
        <textarea
          class="form-control question-input"
          name="question_{{ question.id }}"
          rows="3"
          placeholder="Enter your answer here..."
          required
        ></textarea>
      </div>
      {% endif %}
    </div>
    {% endfor %}

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
      <button type="submit" class="btn btn-primary btn-lg">
        <i class="fas fa-paper-plane"></i> Submit Exam
      </button>
    </div>
  </form>
</div>

<script>
  // Timer functionality
  const examDurationMinutes = "{{ exam.duration_minutes }}";
  let timeRemaining = examDurationMinutes * 60; // Convert to seconds
  const timerDisplay = document.getElementById("timer");
  const examForm = document.getElementById("examForm");

  function updateTimer() {
    const minutes = Math.floor(timeRemaining / 60);
    let seconds = timeRemaining % 60;
    seconds = seconds < 10 ? "0" + seconds : seconds;
    timerDisplay.textContent = `${minutes}:${seconds}`;

    // Change color when time is running low
    if (timeRemaining <= 300) {
      // 5 minutes or less
      timerDisplay.style.color = "#dc3545";
      timerDisplay.style.fontWeight = "bold";
    }

    if (timeRemaining <= 0) {
      clearInterval(timerInterval);
      timerDisplay.textContent = "Time Up!";
      alert("Time is up! Your exam will be submitted.");
      examForm.submit();
    } else {
      timeRemaining--;
    }
  }

  const timerInterval = setInterval(updateTimer, 1000);

  // Progress tracking
  function updateProgress() {
    const questions = document.querySelectorAll(".question");
    let answeredQuestions = 0;

    questions.forEach((question) => {
      const inputs = question.querySelectorAll(".question-input");
      let hasAnswer = false;

      inputs.forEach((input) => {
        if (
          (input.type === "radio" && input.checked) ||
          (input.type === "textarea" && input.value.trim() !== "")
        ) {
          hasAnswer = true;
        }
      });

      if (hasAnswer) {
        answeredQuestions++;
        question.style.borderLeft = "4px solid #28a745";
      } else {
        question.style.borderLeft = "4px solid #dee2e6";
      }
    });

    const progressPercentage = (answeredQuestions / questions.length) * 100;
    document.getElementById(
      "progressBar"
    ).style.width = `${progressPercentage}%`;
    document.getElementById("progressText").textContent = answeredQuestions;
  }

  // Highlight selected radio buttons
  document.querySelectorAll(".form-check-input").forEach((radio) => {
    radio.addEventListener("change", function () {
      const parent = this.closest(".form-check");
      document
        .querySelectorAll(`input[name="${this.name}"]`)
        .forEach((input) => {
          input.closest(".form-check").style.background = "#f8f9fa";
        });
      parent.style.background = "#e3f2fd";
      updateProgress();
    });
  });

  // Auto-resize textareas and track progress
  document.querySelectorAll("textarea.question-input").forEach((textarea) => {
    textarea.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
      updateProgress();
    });
  });

  // Initial progress update
  updateProgress();

  // Form validation
  examForm.addEventListener("submit", function (e) {
    const answeredQuestions = document.querySelectorAll(
      '.question[style*="border-left: 4px solid rgb(40, 167, 69)"]'
    ).length;
    if (answeredQuestions === 0) {
      e.preventDefault();
      alert("Please answer at least one question before submitting.");
      return false;
    }

    if (
      !confirm(
        `You have answered ${answeredQuestions} out of {{ exam.questions|length }} questions. Are you ready to submit?`
      )
    ) {
      e.preventDefault();
      return false;
    }
  });

  // Prevent accidental navigation
  window.addEventListener("beforeunload", function (e) {
    if (timeRemaining > 0 && timeRemaining < examDurationMinutes * 60) {
      e.preventDefault();
      e.returnValue =
        "You have unsaved answers. Are you sure you want to leave?";
    }
  });
</script>
{% endblock %}
