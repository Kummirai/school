{% extends "base.html" %} {% block content %}
<!-- Hero Section -->
<section class="hero-section text-center mt-5">
  <div class="container">
    <h1 class="display-4 fw-bold mb-3">Video Tutorials</h1>
    <p class="lead mb-4">
      Learn from expert educators through comprehensive video lessons
    </p>
  </div>
</section>

<div class="row mb-4 p-3">
  <div class="col-md-6">
    <h2 class="fw-bold">Video Lessons</h2>
  </div>
  <div class="col-md-6">
    <div class="row g-2">
      <div class="col-md-4">
        <select id="grade-select" class="form-select" required>
          <option value="" disabled selected>Select Grade</option>
          <option value="7">Grade 7</option>
          <option value="8">Grade 8</option>
          <option value="9">Grade 9</option>
          <option value="10">Grade 10</option>
          <option value="11">Grade 11</option>
          <option value="12">Grade 12</option>
          <option value="Python">Grade Python</option>
          <option value="Javascript">Grade Javascript</option>
          <option value="HTML">Grade HTML</option>
          <option value="CSS">Grade CSS</option>
          <option value="Excel">Grade Excel</option>
          <option value="Ms Word">Grade Ms Word</option>
          <option value="Powerpoint">Grade Powerpoint</option>
          <option value="Machine Learning">Grade Machine Learning</option>
        </select>
      </div>
      <div class="col-md-5">
        <select id="subject-select" class="form-select" required>
          <option value="" disabled selected>Select Subject</option>
        </select>
      </div>
      <div class="col-md-3">
        <button id="apply-filters" class="btn btn-danger w-100">Search</button>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4 p-3">
  <div class="col-md-12">
    <div class="input-group">
      <input
        type="text"
        id="video-search"
        class="form-control"
        placeholder="Search videos..."
      />
      <button id="search-btn" class="btn btn-outline-secondary" type="button">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </div>
</div>

<!-- Loading Spinner -->
<div id="loading-spinner" class="text-center my-5 d-none">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-2">Loading videos...</p>
</div>

<!-- Videos Container -->
<div id="videos-container" class="row g-4 p-3">
  <div class="col-12 text-center">
    <div class="alert alert-info">
      <i class="bi bi-info-circle-fill"></i> Please select a grade and subject
      to view available video lessons.
    </div>
  </div>
</div>

<!-- No Results Message -->
<div id="no-results" class="text-center my-5 d-none">
  <i class="bi bi-film" style="font-size: 3rem; color: #6c757d"></i>
  <h4 class="mt-3">No videos found</h4>
  <p>Try adjusting your search criteria</p>
</div>

<!-- Error Message -->
<div id="error-message" class="alert alert-danger d-none">
  <i class="bi bi-exclamation-triangle-fill"></i> <span id="error-text"></span>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // State object to track current filters
    const state = {
      grade: "",
      subject: "",
      searchTerm: "",
    };

    // ========== UTILITY FUNCTIONS (defined first) ==========

    function populateSubjectDropdown(subjects) {
      const subjectSelect = document.getElementById("subject-select");
      subjectSelect.innerHTML =
        '<option value="" disabled selected>Select Subject</option>';

      subjects.forEach((subject) => {
        const option = new Option(subject.name, subject.name);
        subjectSelect.add(option);
      });
    }

    function showLoading(show) {
      document
        .getElementById("loading-spinner")
        .classList.toggle("d-none", !show);
    }

    function showError(message) {
      document.getElementById("error-text").textContent = message;
      document.getElementById("error-message").classList.remove("d-none");
    }

    function clearError() {
      document.getElementById("error-message").classList.add("d-none");
    }

    function showNoResults() {
      document.getElementById("videos-container").innerHTML = "";
      document.getElementById("no-results").classList.remove("d-none");
    }

    function showInitialMessage() {
      document.getElementById("videos-container").innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-info">
            <i class="bi bi-info-circle-fill"></i> Please select a grade and subject to view available video lessons.
          </div>
        </div>`;
      document.getElementById("no-results").classList.add("d-none");
      clearError();
    }

    // ========== CORE FUNCTIONALITY ==========

    async function fetchAndPopulateSubjects(grade) {
      try {
        showLoading(true);
        const response = await fetch(
          `/tutorials/api/subjects?grade=${encodeURIComponent(grade)}`
        );
        const data = await response.json();

        if (!response.ok)
          throw new Error(data.error || "Failed to fetch subjects");

        populateSubjectDropdown(data.subjects);
      } catch (error) {
        showError("Failed to load subjects. Please try again.");
        console.error("Subject fetch error:", error);
      } finally {
        showLoading(false);
      }
    }

    async function fetchAndDisplayVideos() {
      try {
        showLoading(true);
        clearError();

        const params = new URLSearchParams();
        params.append("grade", state.grade);
        params.append("subject", state.subject);
        if (state.searchTerm) params.append("search", state.searchTerm);

        const response = await fetch(
          `/tutorials/api/videos?${params.toString()}`
        );
        const data = await response.json();

        if (!response.ok)
          throw new Error(data.error || "Failed to fetch videos");

        if (data.videos.length === 0) {
          showNoResults();
        } else {
          displayVideos(data.videos);
        }
      } catch (error) {
        showError("Failed to load videos. Please try again.");
        console.error("Video fetch error:", error);
      } finally {
        showLoading(false);
      }
    }

    function displayVideos(videos) {
      const container = document.getElementById("videos-container");
      container.innerHTML = "";

      videos.forEach((video) => {
        const col = document.createElement("div");
        col.className = "col-md-4 col-lg-3 mb-4";
        col.innerHTML = `
          <div class="card video-card h-100">
            <img data-src="${video.thumbnail}" class="card-img-top lazy" alt="${video.title}">
            <div class="card-body">
              <h5 class="card-title">${video.title}</h5>
              <p class="card-text">${video.description}</p>
              <div class="d-flex justify-content-between">
                <span class="badge bg-primary">${video.subject}</span>
                <span class="badge bg-secondary">${video.grade}</span>
              </div>
            </div>
            <div class="card-footer bg-transparent">
              <button class="btn btn-sm btn-primary watch-btn w-100" data-video-id="${video.youtubeid}">
                <i class="bi bi-play-fill"></i> Watch Now
              </button>
            </div>
          </div>
        `;
        container.appendChild(col);
      });

      // Set up watch buttons
      setupWatchButtons();
      initLazyLoading();
    }

    function setupWatchButtons() {
      document.querySelectorAll(".watch-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          openVideoModal(this.dataset.videoId);
        });
      });
    }

    function initLazyLoading() {
      const lazyImages = [].slice.call(document.querySelectorAll("img.lazy"));

      if ("IntersectionObserver" in window) {
        const lazyImageObserver = new IntersectionObserver(function (entries) {
          entries.forEach(function (entry) {
            if (entry.isIntersecting) {
              const lazyImage = entry.target;
              lazyImage.src = lazyImage.dataset.src;
              lazyImage.classList.remove("lazy");
              lazyImageObserver.unobserve(lazyImage);
            }
          });
        });

        lazyImages.forEach(function (lazyImage) {
          lazyImageObserver.observe(lazyImage);
        });
      } else {
        // Fallback for browsers without IntersectionObserver
        lazyImages.forEach(function (lazyImage) {
          lazyImage.src = lazyImage.dataset.src;
        });
      }
    }

    function openVideoModal(videoId) {
      const modalHTML = `
        <div class="modal fade" id="videoModal" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Video Tutorial</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body p-0">
                <div class="ratio ratio-16x9">
                  <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                          allowfullscreen 
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                  </iframe>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Remove existing modal if any
      const existingModal = document.getElementById("videoModal");
      if (existingModal) existingModal.remove();

      // Add new modal
      document.body.insertAdjacentHTML("beforeend", modalHTML);

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById("videoModal"));
      modal.show();

      // Clean up on close
      document
        .getElementById("videoModal")
        .addEventListener("hidden.bs.modal", function () {
          this.remove();
        });
    }

    // ========== EVENT HANDLERS ==========

    function setupEventListeners() {
      // Grade select change
      document
        .getElementById("grade-select")
        .addEventListener("change", async function () {
          state.grade = this.value;
          if (state.grade) {
            await fetchAndPopulateSubjects(state.grade);
          }
        });

      // Subject select change
      document
        .getElementById("subject-select")
        .addEventListener("change", function () {
          state.subject = this.value;
        });

      // Search input
      document
        .getElementById("video-search")
        .addEventListener("input", function () {
          state.searchTerm = this.value.trim();
        });

      // Apply filters button
      document
        .getElementById("apply-filters")
        .addEventListener("click", function () {
          if (!state.grade) {
            showError("Please select a grade first");
            return;
          }
          if (!state.subject) {
            showError("Please select a subject");
            return;
          }
          fetchAndDisplayVideos();
        });

      // Search button and Enter key
      document
        .getElementById("search-btn")
        .addEventListener("click", function () {
          fetchAndDisplayVideos();
        });
      document
        .getElementById("video-search")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") fetchAndDisplayVideos();
        });
    }

    // ========== INITIALIZATION ==========

    async function initialize() {
      setupEventListeners();
      showInitialMessage();
      // Populate subjects on initial load
      await fetchAndPopulateSubjects(''); 
    }

    // Start the application
    initialize();
  });
</script>
{% endblock %}
