Index: app.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>from functools import wraps\r\nfrom flask import Flask, flash, redirect, render_template, redirect, request, session, url_for, jsonify\r\nfrom werkzeug.security import check_password_hash, generate_password_hash\r\nfrom werkzeug.utils import secure_filename\r\nimport os\r\nimport psycopg2\r\nfrom dotenv import load_dotenv\r\nfrom datetime import datetime, timedelta\r\nfrom flask import render_template\r\nfrom flask_login import current_user, login_required\r\nimport json\r\n\r\n# Load environment variables\r\nload_dotenv()\r\n\r\n# Create Flask app\r\napp = Flask(__name__)\r\n#app.secret_key = os.getenv('FLASK_SECRET_KEY')\r\napp.secret_key = os.environ.get('FLASK_SECRET_KEY', 'fallback-secret-key-for-development')\r\napp.jinja_env.globals.update(float=float)\r\n\r\n\r\n# Configure upload folder in your app\r\nUPLOAD_FOLDER = os.path.join('static', 'uploads')\r\nos.makedirs(UPLOAD_FOLDER, exist_ok=True)\r\napp.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER\r\n\r\nif not app.secret_key:\r\n    raise ValueError(\"No secret key set for Flask application\")\r\n\r\n# Database connection\r\ndef get_db_connection():\r\n    try:\r\n        conn = psycopg2.connect(\r\n            host=os.getenv('host'),\r\n            database=os.getenv('dbname'),\r\n            user=os.getenv('user'),\r\n            password=os.getenv('password'),\r\n            port=os.getenv('5432'),\r\n            # sslmode='require'\r\n        )\r\n        print(\"✅ Successfully connected to Supabase!\")\r\n        return conn\r\n    except Exception as e:\r\n        print(f\"❌ Connection failed: {e}\")\r\n        raise\r\n\r\n# Example usage\r\n# client = get_db_connection()\r\n# result = client.table('users').select(\"*\").execute()\r\n\r\ndef initialize_database():\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n\r\n    # Add this after your other table creations\r\n    cur.execute('''\r\n        CREATE TABLE IF NOT EXISTS announcements (\r\n            id SERIAL PRIMARY KEY,\r\n            title VARCHAR(255) NOT NULL,\r\n            message TEXT NOT NULL,\r\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n            created_by INTEGER REFERENCES users(id) ON DELETE SET NULL\r\n        )\r\n    ''')\r\n    \r\n    cur.execute('''\r\n        CREATE TABLE IF NOT EXISTS user_announcements (\r\n            announcement_id INTEGER NOT NULL REFERENCES announcements(id) ON DELETE CASCADE,\r\n            user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\r\n            is_read BOOLEAN DEFAULT FALSE,\r\n            read_at TIMESTAMP,\r\n            PRIMARY KEY (announcement_id, user_id)\r\n        )\r\n    ''')\r\n    \r\n    # Create users table\r\n    cur.execute('''\r\n    CREATE TABLE IF NOT EXISTS users (\r\n        id SERIAL PRIMARY KEY,\r\n        username VARCHAR(255) UNIQUE NOT NULL,\r\n        password TEXT NOT NULL,\r\n        role VARCHAR(50) NOT NULL\r\n    )\r\n    ''')\r\n\r\n    # Subscription tables\r\n    cur.execute('''\r\n        CREATE TABLE IF NOT EXISTS subscription_plans (\r\n            id SERIAL PRIMARY KEY,\r\n            name VARCHAR(100) UNIQUE NOT NULL,\r\n            description TEXT,\r\n            price DECIMAL(10,2) NOT NULL,\r\n            duration_days INTEGER NOT NULL\r\n        )\r\n    ''')\r\n\r\n    cur.execute('''\r\n            CREATE TABLE IF NOT EXISTS exam_results (\r\n                id SERIAL PRIMARY KEY,\r\n                user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\r\n                exam_id INTEGER NOT NULL, -- Storing the JSON exam ID\r\n                score DECIMAL(5,2) NOT NULL, -- Store score as a percentage or points\r\n                total_questions INTEGER NOT NULL,\r\n                completion_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP\r\n            )\r\n        ''')\r\n\r\n    cur.execute('''\r\n        CREATE TABLE IF NOT EXISTS subscriptions (\r\n            id SERIAL PRIMARY KEY,\r\n            user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\r\n            plan_id INTEGER NOT NULL REFERENCES subscription_plans(id) ON DELETE CASCADE,\r\n            start_date TIMESTAMP NOT NULL,\r\n            end_date TIMESTAMP NOT NULL,\r\n            is_active BOOLEAN DEFAULT FALSE,\r\n            payment_status VARCHAR(50) DEFAULT 'pending',\r\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\r\n        )\r\n    ''')\r\n\r\n    cur.execute('''\r\n        CREATE TABLE IF NOT EXISTS payments (\r\n            id SERIAL PRIMARY KEY,\r\n            subscription_id INTEGER NOT NULL REFERENCES subscriptions(id) ON DELETE CASCADE,\r\n            amount DECIMAL(10,2) NOT NULL,\r\n            payment_date TIMESTAMP NOT NULL,\r\n            transaction_id VARCHAR(255),\r\n            status VARCHAR(50) NOT NULL,\r\n            receipt_url VARCHAR(255)\r\n        )\r\n    ''')\r\n    \r\n    # Create tutorial_categories table\r\n    cur.execute('''\r\n    CREATE TABLE IF NOT EXISTS tutorial_categories (\r\n        id SERIAL PRIMARY KEY,\r\n        name VARCHAR(255) NOT NULL\r\n    )\r\n    ''')\r\n\r\n      # Add these new tables for assignment system\r\n    cur.execute('''\r\n    CREATE TABLE IF NOT EXISTS assignments (\r\n        id SERIAL PRIMARY KEY,\r\n        title VARCHAR(255) NOT NULL,\r\n        description TEXT,\r\n        subject VARCHAR(100) NOT NULL,\r\n        total_marks INTEGER NOT NULL,\r\n        deadline TIMESTAMP,\r\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        content TEXT -- New column for interactive assignment content\r\n    )\r\n    ''')\r\n\r\n    cur.execute('''\r\n    CREATE TABLE IF NOT EXISTS assignment_submissions (\r\n        id SERIAL PRIMARY KEY,\r\n        assignment_id INTEGER REFERENCES assignments(id) ON DELETE CASCADE,\r\n        student_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\r\n        submission_text TEXT,\r\n        file_path VARCHAR(255),\r\n        submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n        marks_obtained INTEGER,\r\n        feedback TEXT,\r\n        interactive_submission_data JSONB, -- New column for interactive submission data\r\n        CONSTRAINT unique_submission UNIQUE (assignment_id, student_id)\r\n    )\r\n    ''')\r\n\r\n        # Add this to the initialize_database() function\r\n    cur.execute('''\r\n        CREATE TABLE IF NOT EXISTS practice_scores (\r\n            id SERIAL PRIMARY KEY,\r\n            student_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\r\n            subject VARCHAR(50) NOT NULL,\r\n            topic VARCHAR(100) NOT NULL,\r\n            score INTEGER NOT NULL,\r\n            total_questions INTEGER NOT NULL,\r\n            completed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n            CONSTRAINT unique_practice_attempt UNIQUE (student_id, subject, topic)\r\n        )\r\n    ''')\r\n\r\n    # Add this new table for assignment-user relationships\r\n    cur.execute('''\r\n        CREATE TABLE IF NOT EXISTS assignment_users (\r\n            assignment_id INTEGER NOT NULL REFERENCES assignments(id) ON DELETE CASCADE,\r\n            user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\r\n            PRIMARY KEY (assignment_id, user_id)\r\n        )\r\n    ''')\r\n\r\n    \r\n    # Create tutorial_videos table\r\n    cur.execute('''\r\n    CREATE TABLE IF NOT EXISTS tutorial_videos (\r\n        id SERIAL PRIMARY KEY,\r\n        title VARCHAR(255) NOT NULL,\r\n        url TEXT NOT NULL,\r\n        category_id INTEGER NOT NULL REFERENCES tutorial_categories(id) ON DELETE CASCADE\r\n    )\r\n    ''')\r\n\r\n    # Create tutorial_sessions table\r\n    cur.execute('''\r\n    CREATE TABLE IF NOT EXISTS tutorial_sessions (\r\n        id SERIAL PRIMARY KEY,\r\n        title VARCHAR(255) NOT NULL,\r\n        description TEXT,\r\n        start_time TIMESTAMP NOT NULL,\r\n        end_time TIMESTAMP NOT NULL,\r\n        max_students INTEGER NOT NULL\r\n    )\r\n    ''')\r\n\r\n    # Create student_bookings table\r\n    # In your initialize_database() function\r\n    cur.execute('''\r\n    CREATE TABLE IF NOT EXISTS student_bookings (\r\n        id SERIAL PRIMARY KEY,\r\n        student_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\r\n        session_id INTEGER NOT NULL REFERENCES tutorial_sessions(id) ON DELETE CASCADE,\r\n        booking_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n        status VARCHAR(50) DEFAULT 'confirmed',\r\n        CONSTRAINT unique_booking UNIQUE (student_id, session_id)\r\n    )\r\n    ''')\r\n\r\n    conn.commit()\r\n\r\n     # >>> ADDED: Check if subscription plans exist before inserting defaults\r\n    cur.execute('SELECT COUNT(*) FROM subscription_plans')\r\n    plan_count = cur.fetchone()[0]\r\n\r\n    if plan_count == 0:\r\n        # Insert default subscription plans if they don't exist\r\n        cur.execute('''\r\n            INSERT INTO subscription_plans (name, description, price, duration_days)\r\n            VALUES\r\n                ('Access', 'Access to core tutorials and study guides', 99.99, 30),\r\n                ('Premium', 'All features including priority support', 199.99, 30),\r\n                ('Standard', 'Access to core tutorials, study guides and Exams', 149.99, 30),\r\n                \r\n        ''')\r\n        conn.commit() # Commit is done once at the end\r\n        print(\"✅ Default subscription plans inserted.\")\r\n    else:\r\n        print(\"Subscription plans already exist, skipping default insert.\")\r\n    # <<< END ADDED\r\n\r\n    # Check if there are any users\r\n    cur.execute('SELECT COUNT(*) FROM users')\r\n    user_count = cur.fetchone()[0]\r\n\r\n    if user_count == 0:\r\n        # Insert default admin user\r\n        default_admin_username = 'admin'\r\n        default_admin_password = generate_password_hash('admin123')\r\n        cur.execute('''\r\n            INSERT INTO users (username, password, role)\r\n            VALUES (%s, %s, %s)\r\n        ''', (default_admin_username, default_admin_password, 'admin'))\r\n        conn.commit()\r\n        print(\"✅ Default admin user created: admin / admin123\")\r\n\r\n    cur.close()\r\n    conn.close()\r\n\r\n# Helpers\r\ndef get_unread_announcements_count(user_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            SELECT COUNT(*) \r\n            FROM user_announcements \r\n            WHERE user_id = %s AND is_read = FALSE\r\n        ''', (user_id,))\r\n        return cur.fetchone()[0]\r\n    except Exception as e:\r\n        print(f\"Error getting unread announcements count: {e}\")\r\n        return 0\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\n# Add these helper functions to app.py\r\ndef create_announcement(title, message, created_by, user_ids=None):\r\n    \"\"\"Create a new announcement and optionally assign to specific users\"\"\"\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        # Create the announcement\r\n        cur.execute('''\r\n            INSERT INTO announcements (title, message, created_by)\r\n            VALUES (%s, %s, %s)\r\n            RETURNING id\r\n        ''', (title, message, created_by))\r\n        announcement_id = cur.fetchone()[0]\r\n        \r\n        # If user_ids is None, send to all users\r\n        if user_ids is None:\r\n            cur.execute('SELECT id FROM users WHERE role = %s', ('student',))\r\n            user_ids = [row[0] for row in cur.fetchall()]\r\n        \r\n        # Assign to selected users\r\n        for user_id in user_ids:\r\n            cur.execute('''\r\n                INSERT INTO user_announcements (announcement_id, user_id)\r\n                VALUES (%s, %s)\r\n            ''', (announcement_id, user_id))\r\n        \r\n        conn.commit()\r\n        return announcement_id\r\n    except Exception as e:\r\n        conn.rollback()\r\n        raise e\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef get_user_announcements(user_id, limit=None):\r\n    \"\"\"Get announcements for a specific user\"\"\"\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        query = '''\r\n            SELECT a.id, a.title, a.message, a.created_at, \r\n                   u.username as created_by, ua.is_read\r\n            FROM announcements a\r\n            JOIN user_announcements ua ON a.id = ua.announcement_id\r\n            JOIN users u ON a.created_by = u.id\r\n            WHERE ua.user_id = %s\r\n            ORDER BY a.created_at DESC\r\n        '''\r\n        \r\n        if limit:\r\n            query += ' LIMIT %s'\r\n            cur.execute(query, (user_id, limit))\r\n        else:\r\n            cur.execute(query, (user_id,))\r\n            \r\n        announcements = []\r\n        for row in cur.fetchall():\r\n            announcements.append({\r\n                'id': row[0],\r\n                'title': row[1],\r\n                'message': row[2],\r\n                'created_at': row[3],\r\n                'created_by': row[4],\r\n                'is_read': row[5]\r\n            })\r\n            \r\n        return announcements\r\n    except Exception as e:\r\n        print(f\"Error getting announcements: {e}\")\r\n        return []\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef mark_announcement_read(announcement_id, user_id):\r\n    \"\"\"Mark an announcement as read for a user\"\"\"\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            UPDATE user_announcements\r\n            SET is_read = TRUE, read_at = CURRENT_TIMESTAMP\r\n            WHERE announcement_id = %s AND user_id = %s\r\n        ''', (announcement_id, user_id))\r\n        conn.commit()\r\n        return True\r\n    except Exception as e:\r\n        conn.rollback()\r\n        print(f\"Error marking announcement as read: {e}\")\r\n        return False\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef get_all_announcements():\r\n    \"\"\"Get all announcements for admin view\"\"\"\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            SELECT a.id, a.title, a.message, a.created_at, \r\n                   u.username as created_by,\r\n                   COUNT(ua.user_id) as recipient_count\r\n            FROM announcements a\r\n            JOIN users u ON a.created_by = u.id\r\n            LEFT JOIN user_announcements ua ON a.id = ua.announcement_id\r\n            GROUP BY a.id, u.username\r\n            ORDER BY a.created_at DESC\r\n        ''')\r\n        \r\n        announcements = []\r\n        for row in cur.fetchall():\r\n            announcements.append({\r\n                'id': row[0],\r\n                'title': row[1],\r\n                'message': row[2],\r\n                'created_at': row[3],\r\n                'created_by': row[4],\r\n                'recipient_count': row[5]\r\n            })\r\n            \r\n        return announcements\r\n    except Exception as e:\r\n        print(f\"Error getting all announcements: {e}\")\r\n        return []\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef load_exams_from_json(filepath='static/js/exams.json'):\r\n    \"\"\"Loads exam data from a JSON file.\"\"\"\r\n    try:\r\n        with open(filepath, 'r') as f:\r\n            exams_data = json.load(f)\r\n            return exams_data\r\n    except FileNotFoundError:\r\n        print(f\"Error: Exam data file not found at {filepath}\")\r\n        return []\r\n    except json.JSONDecodeError:\r\n        print(f\"Error: Could not decode JSON from {filepath}. Check file format.\")\r\n        return []\r\n    except Exception as e:\r\n        print(f\"An unexpected error occurred loading exam data: {e}\")\r\n        return []\r\n\r\n# Add this new helper function to app.py\r\ndef add_subscription_to_db(user_id, plan_id, start_date, end_date, is_active=False, payment_status='pending'):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            INSERT INTO subscriptions\r\n            (user_id, plan_id, start_date, end_date, is_active, payment_status)\r\n            VALUES (%s, %s, %s, %s, %s, %s)\r\n            RETURNING id\r\n        ''', (user_id, plan_id, start_date, end_date, is_active, payment_status))\r\n        subscription_id = cur.fetchone()[0]\r\n        conn.commit()\r\n        return subscription_id\r\n    except Exception as e:\r\n        conn.rollback()\r\n        print(f\"Error adding subscription: {e}\")\r\n        return None\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef get_subscription_plans():\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('SELECT * FROM subscription_plans')\r\n    plans = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n    return plans\r\n\r\ndef get_user_subscription(user_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('''\r\n        SELECT s.id, p.name, p.price, s.start_date, s.end_date, s.is_active, s.payment_status\r\n        FROM subscriptions s\r\n        JOIN subscription_plans p ON s.plan_id = p.id\r\n        WHERE s.user_id = %s\r\n        ORDER BY s.end_date DESC\r\n        LIMIT 1\r\n    ''', (user_id,))\r\n    subscription = cur.fetchone()\r\n    cur.close()\r\n    conn.close()\r\n    return subscription\r\n\r\ndef get_all_subscriptions():\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('''\r\n        SELECT s.id, u.username, p.name, p.price, s.start_date, s.end_date, \r\n               s.is_active, s.payment_status, s.created_at\r\n        FROM subscriptions s\r\n        JOIN users u ON s.user_id = u.id\r\n        JOIN subscription_plans p ON s.plan_id = p.id\r\n        ORDER BY s.end_date DESC\r\n    ''')\r\n    subscriptions = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n    return subscriptions\r\n\r\ndef mark_subscription_as_paid(subscription_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            UPDATE subscriptions\r\n            SET payment_status = 'paid', is_active = TRUE\r\n            WHERE id = %s\r\n            RETURNING user_id, plan_id\r\n        ''', (subscription_id,))\r\n        result = cur.fetchone()\r\n        \r\n        if result:\r\n            user_id, plan_id = result\r\n            # Update user's role if needed (e.g., give premium access)\r\n            cur.execute('''\r\n                UPDATE users\r\n                SET role = CASE \r\n                    WHEN %s = 2 THEN 'premium' \r\n                    ELSE role \r\n                END\r\n                WHERE id = %s\r\n            ''', (plan_id, user_id))\r\n        \r\n        conn.commit()\r\n        return True\r\n    except Exception as e:\r\n        conn.rollback()\r\n        print(f\"Error marking subscription as paid: {e}\")\r\n        return False\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef record_practice_score(student_id, subject, topic, score, total_questions):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            INSERT INTO practice_scores \r\n            (student_id, subject, topic, score, total_questions)\r\n            VALUES (%s, %s, %s, %s, %s)\r\n            ON CONFLICT (student_id, subject, topic) \r\n            DO UPDATE SET \r\n                score = EXCLUDED.score,\r\n                total_questions = EXCLUDED.total_questions,\r\n                completed_at = CURRENT_TIMESTAMP\r\n            WHERE practice_scores.score < EXCLUDED.score\r\n        ''', (student_id, subject, topic, score, total_questions))\r\n        conn.commit()\r\n        return True\r\n    except Exception as e:\r\n        conn.rollback()\r\n        print(f\"Error recording practice score: {e}\")\r\n        return False\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef get_leaderboard(subject=None, topic=None, time_period='all', limit=20):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        # Calculate leaderboard based on (total score / number of attempts)\r\n        query = '''\r\n            SELECT \r\n                u.id,\r\n                u.username,\r\n                ROUND(SUM(ps.score)::numeric / COUNT(ps.id), 2) as avg_score,\r\n                COUNT(ps.id) as attempt_count,\r\n                ROUND(AVG(ps.score::numeric / ps.total_questions * 100), 2) as avg_percentage\r\n            FROM users u\r\n            JOIN practice_scores ps ON u.id = ps.student_id\r\n            WHERE u.role = 'student'\r\n        '''\r\n        params = []\r\n        \r\n        if subject:\r\n            query += ' AND ps.subject = %s'\r\n            params.append(subject)\r\n        if topic:\r\n            query += ' AND ps.topic = %s'\r\n            params.append(topic)\r\n            \r\n        if time_period == 'week':\r\n            query += ' AND ps.completed_at >= CURRENT_DATE - INTERVAL \\'7 days\\''\r\n        elif time_period == 'month':\r\n            query += ' AND ps.completed_at >= CURRENT_DATE - INTERVAL \\'30 days\\''\r\n            \r\n        query += '''\r\n            GROUP BY u.id, u.username\r\n            HAVING COUNT(ps.id) > 0\r\n            ORDER BY avg_score DESC, attempt_count DESC\r\n        '''\r\n        \r\n        if limit:\r\n            query += ' LIMIT %s'\r\n            params.append(limit)\r\n        \r\n        cur.execute(query, params)\r\n        \r\n        leaderboard = []\r\n        rank = 0\r\n        prev_avg = None\r\n        actual_rank = 0\r\n        \r\n        for row in cur.fetchall():\r\n            # Handle ties in average score\r\n            if row[2] != prev_avg:\r\n                actual_rank = rank + 1\r\n            prev_avg = row[2]\r\n            rank += 1\r\n            \r\n            leaderboard.append({\r\n                'user_id': row[0],\r\n                'username': row[1],\r\n                'avg_score': row[2],\r\n                'attempt_count': row[3],\r\n                'avg_percentage': row[4],\r\n                'rank': actual_rank\r\n            })\r\n        \r\n        # Get current user's stats if logged in\r\n        user_stats = None\r\n        user_rank = None\r\n        if 'user_id' in session:\r\n            # Get user's total score divided by attempts\r\n            cur.execute('''\r\n                SELECT \r\n                    ROUND(SUM(score)::numeric / COUNT(id), 2) as avg_score,\r\n                    COUNT(*) as attempt_count,\r\n                    ROUND(AVG(score::numeric / total_questions * 100), 2) as avg_percentage\r\n                FROM practice_scores\r\n                WHERE student_id = %s\r\n            ''', (session['user_id'],))\r\n            avg_result = cur.fetchone()\r\n            \r\n            if avg_result and avg_result[0]:\r\n                user_stats = {\r\n                    'avg_score': avg_result[0],\r\n                    'attempt_count': avg_result[1],\r\n                    'avg_percentage': avg_result[2]\r\n                }\r\n                \r\n                # Get user's rank based on (total score / attempts)\r\n                cur.execute('''\r\n                    WITH ranked_students AS (\r\n                        SELECT \r\n                            student_id,\r\n                            SUM(score)::numeric / COUNT(id) as avg_score,\r\n                            DENSE_RANK() OVER (ORDER BY (SUM(score)::numeric / COUNT(id)) DESC) as rank\r\n                        FROM practice_scores\r\n                        GROUP BY student_id\r\n                    )\r\n                    SELECT rank \r\n                    FROM ranked_students\r\n                    WHERE student_id = %s\r\n                ''', (session['user_id'],))\r\n                rank_result = cur.fetchone()\r\n                if rank_result:\r\n                    user_rank = rank_result[0]\r\n        \r\n        return leaderboard, user_stats, user_rank\r\n        \r\n    except Exception as e:\r\n        print(f\"Error getting leaderboard: {e}\")\r\n        return [], None, None\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\n# Add this helper function to get user by ID\r\ndef get_user_by_id(user_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('SELECT id, username FROM users WHERE id = %s', (user_id,))\r\n    user = cur.fetchone()\r\n    cur.close()\r\n    conn.close()\r\n    if user:\r\n        return {'id': user[0], 'username': user[1]}\r\n\r\ndef get_submission_for_grading(assignment_id, student_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        # Get submission details, including interactive_submission_data\r\n        cur.execute('''\r\n            SELECT s.id, s.submission_text, s.file_path, s.submitted_at,\r\n                   s.marks_obtained, s.feedback, u.username, s.interactive_submission_data\r\n            FROM assignment_submissions s\r\n            JOIN users u ON s.student_id = u.id\r\n            WHERE s.assignment_id = %s AND s.student_id = %s\r\n        ''', (assignment_id, student_id))\r\n        submission = cur.fetchone()\r\n\r\n        if not submission:\r\n            return None\r\n\r\n        # Get assignment details, including content\r\n        cur.execute('SELECT id, title, total_marks, content FROM assignments WHERE id = %s', (assignment_id,))\r\n        assignment = cur.fetchone()\r\n\r\n        # Parse the content if it exists\r\n        content = None\r\n        if assignment[3]:  # content is at index 3\r\n            try:\r\n                content = json.loads(assignment[3])\r\n            except (TypeError, json.JSONDecodeError):\r\n                content = assignment[3]  # fallback to raw content if not JSON\r\n\r\n        return {\r\n            'submission': {\r\n                'id': submission[0],\r\n                'submission_text': submission[1],\r\n                'file_path': submission[2],\r\n                'submitted_at': submission[3],\r\n                'marks_obtained': submission[4],\r\n                'feedback': submission[5],\r\n                'username': submission[6],\r\n                'interactive_submission_data': submission[7]\r\n            },\r\n            'assignment': {\r\n                'id': assignment[0],\r\n                'title': assignment[1],\r\n                'total_marks': assignment[2],\r\n                'content': content  # Now properly parsed\r\n            }\r\n        }\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef update_submission_grade(assignment_id, student_id, marks_obtained, feedback):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            UPDATE assignment_submissions\r\n            SET marks_obtained = %s, feedback = %s\r\n            WHERE assignment_id = %s AND student_id = %s\r\n        ''', (marks_obtained, feedback, assignment_id, student_id))\r\n        conn.commit()\r\n        return True\r\n    except Exception as e:\r\n        conn.rollback()\r\n        app.logger.error(f\"Error updating grade: {str(e)}\")\r\n        return False\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef get_all_assignments():\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('SELECT * FROM assignments ORDER BY deadline')\r\n    assignments = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n    return assignments\r\n\r\n\r\ndef get_assignments_for_user(user_id):\r\n    \"\"\"Get assignments assigned to a specific user\"\"\"\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            SELECT a.id, a.title, a.subject, a.deadline, a.total_marks, a.description\r\n            FROM assignments a\r\n            JOIN assignment_users au ON a.id = au.assignment_id\r\n            WHERE au.user_id = %s\r\n            ORDER BY a.deadline\r\n        ''', (user_id,))\r\n        \r\n        assignments = []\r\n        for row in cur.fetchall():\r\n            assignments.append({\r\n                'id': row[0],\r\n                'title': row[1],\r\n                'subject': row[2],\r\n                'deadline': row[3],\r\n                'total_marks': row[4],\r\n                'description': row[5],\r\n                'status': 'active' if row[3] > datetime.utcnow() else 'expired'\r\n            })\r\n            \r\n        return assignments\r\n    except Exception as e:\r\n        app.logger.error(f\"Error getting assignments for user {user_id}: {str(e)}\")\r\n        return []\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef add_assignment(title, description, subject, total_marks, deadline, assigned_students_ids, content=None):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            INSERT INTO assignments (title, description, subject, total_marks, deadline, content)\r\n            VALUES (%s, %s, %s, %s, %s, %s)\r\n            RETURNING id\r\n        ''', (title, description, subject, total_marks, deadline, content)) # Include content here\r\n        assignment_id = cur.fetchone()[0]\r\n\r\n        for student_id in assigned_students_ids:\r\n            cur.execute('''\r\n                INSERT INTO assignment_users (assignment_id, user_id)\r\n                VALUES (%s, %s)\r\n            ''', (assignment_id, student_id))\r\n\r\n        conn.commit()\r\n        return True\r\n    except Exception as e:\r\n        conn.rollback()\r\n        print(f\"Error adding assignment: {e}\")\r\n        return False\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\n\r\ndef get_assignment_details(assignment_id):\r\n    \"\"\"Get full details for a specific assignment\"\"\"\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            SELECT id, title, description, subject,\r\n                   total_marks, deadline, created_at, content\r\n            FROM assignments\r\n            WHERE id = %s\r\n        ''', (assignment_id,))\r\n        assignment = cur.fetchone()\r\n        return assignment\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef get_student_submission(student_id, assignment_id):\r\n    \"\"\"Get a student's submission for an assignment\"\"\"\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            SELECT id, submission_text, file_path, submitted_at, \r\n                   marks_obtained, feedback\r\n            FROM assignment_submissions\r\n            WHERE student_id = %s AND assignment_id = %s\r\n        ''', (student_id, assignment_id))\r\n        submission = cur.fetchone()\r\n        return submission\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef get_student_submissions(student_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('''\r\n        SELECT a.title, a.subject, a.deadline, s.submitted_at, \r\n               s.marks_obtained, a.total_marks, s.feedback, s.file_path\r\n        FROM assignment_submissions s\r\n        JOIN assignments a ON s.assignment_id = a.id\r\n        WHERE s.student_id = %s\r\n        ORDER BY a.deadline DESC\r\n    ''', (student_id,))\r\n    \r\n    # Convert tuples to dictionaries with meaningful keys\r\n    submissions = []\r\n    for row in cur.fetchall():\r\n        submissions.append({\r\n            'title': row[0],\r\n            'subject': row[1],\r\n            'deadline': row[2],\r\n            'submitted_at': row[3],\r\n            'marks_obtained': row[4],\r\n            'total_marks': row[5],\r\n            'feedback': row[6],\r\n            'file_path': row[7]\r\n        })\r\n    \r\n    cur.close()\r\n    conn.close()\r\n    return submissions\r\n\r\ndef submit_assignment(assignment_id, student_id, submission_text, file_path=None, interactive_submission_data=None):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            INSERT INTO assignment_submissions\r\n            (assignment_id, student_id, submission_text, file_path, interactive_submission_data)\r\n            VALUES (%s, %s, %s, %s, %s)\r\n            ON CONFLICT (assignment_id, student_id) DO UPDATE\r\n            SET submission_text = EXCLUDED.submission_text,\r\n                file_path = EXCLUDED.file_path,\r\n                submitted_at = CURRENT_TIMESTAMP,\r\n                interactive_submission_data = EXCLUDED.interactive_submission_data -- Update interactive data\r\n            RETURNING id\r\n        ''', (assignment_id, student_id, submission_text, file_path, interactive_submission_data)) # Include interactive_submission_data here\r\n        submission_id = cur.fetchone()[0]\r\n        conn.commit()\r\n        return True\r\n    except Exception as e:\r\n        conn.rollback()\r\n        print(f\"Error submitting assignment: {e}\")\r\n        return False\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\ndef get_user_by_username(username):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('SELECT id, username, password, role FROM users WHERE username = %s', (username,))\r\n    user = cur.fetchone()\r\n    cur.close()\r\n    conn.close()\r\n    if user:\r\n        return {\r\n            'id': user[0],\r\n            'username': user[1],\r\n            'password': user[2],\r\n            'role': user[3]\r\n        }\r\n    return None\r\n\r\ndef get_student_bookings(student_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('''\r\n        SELECT sb.id, ts.title, ts.start_time, ts.end_time\r\n        FROM student_bookings sb\r\n        JOIN tutorial_sessions ts ON sb.session_id = ts.id\r\n        WHERE sb.student_id = %s AND ts.start_time > NOW()\r\n        ORDER BY ts.start_time\r\n    ''', (student_id,))\r\n    bookings = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n    return bookings\r\n\r\ndef get_all_categories():\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('SELECT id, name FROM tutorial_categories')\r\n    categories = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n    return categories\r\n\r\ndef get_category_name(category_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('SELECT name FROM tutorial_categories WHERE id = %s', (category_id,))\r\n    category = cur.fetchone()\r\n    cur.close()\r\n    conn.close()\r\n    return category[0] if category else \"Unknown Category\"\r\n\r\ndef get_videos_by_category(category_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('SELECT id, title, url FROM tutorial_videos WHERE category_id = %s', (category_id,))\r\n    rows = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n\r\n    # Convert to list of dictionaries\r\n    videos = [\r\n        {'id': row[0], 'title': row[1], 'url': row[2]}\r\n        for row in rows\r\n    ]\r\n    return videos\r\n\r\ndef get_students():\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('SELECT id, username FROM users WHERE role = %s', ('student',))\r\n    students = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n    return students\r\n\r\ndef add_student_to_db(username, password):  # Changed from add_student\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('INSERT INTO users (username, password, role) VALUES (%s, %s, %s)',\r\n                (username, generate_password_hash(password), 'student'))\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\ndef delete_student_by_id(student_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('DELETE FROM users WHERE id = %s AND role = %s', (student_id, 'student'))\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\ndef get_all_sessions():\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('''\r\n        SELECT ts.id, ts.title, ts.description, ts.start_time, ts.end_time, ts.max_students,\r\n            COUNT(sb.id) as booked_count\r\n        FROM tutorial_sessions ts\r\n        LEFT JOIN student_bookings sb ON ts.id = sb.session_id\r\n        GROUP BY ts.id\r\n        ORDER BY ts.start_time\r\n    ''')\r\n    sessions = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n    return sessions\r\n\r\ndef get_upcoming_sessions():\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('''\r\n        SELECT ts.id, ts.title, ts.start_time, ts.end_time,\r\n               COUNT(sb.id) as booked_count, ts.max_students\r\n        FROM tutorial_sessions ts\r\n        LEFT JOIN student_bookings sb ON ts.id = sb.session_id\r\n        WHERE ts.start_time > NOW()\r\n        GROUP BY ts.id\r\n        ORDER BY ts.start_time\r\n        LIMIT 5\r\n    ''')\r\n    sessions = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n    return sessions\r\n\r\ndef get_student_bookings(student_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('''\r\n        SELECT sb.id, ts.title, ts.start_time, ts.end_time\r\n        FROM student_bookings sb\r\n        JOIN tutorial_sessions ts ON sb.session_id = ts.id\r\n        WHERE sb.student_id = %s AND ts.start_time > NOW()\r\n        ORDER BY ts.start_time\r\n    ''', (student_id,))\r\n    bookings = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n    return bookings\r\n\r\ndef create_session(title, description, start_time, end_time, max_students):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('''\r\n        INSERT INTO tutorial_sessions (title, description, start_time, end_time, max_students)\r\n        VALUES (%s, %s, %s, %s, %s)\r\n        RETURNING id\r\n    ''', (title, description, start_time, end_time, max_students))\r\n    session_id = cur.fetchone()[0]\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n    return session_id\r\n\r\ndef book_session(student_id, session_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    \r\n    # Check if session exists and has available spots\r\n    cur.execute('''\r\n        SELECT COUNT(sb.id), ts.max_students\r\n        FROM tutorial_sessions ts\r\n        LEFT JOIN student_bookings sb ON ts.id = sb.session_id\r\n        WHERE ts.id = %s\r\n        GROUP BY ts.id\r\n    ''', (session_id,))\r\n    result = cur.fetchone()\r\n    \r\n    if not result or result[0] >= result[1]:\r\n        cur.close()\r\n        conn.close()\r\n        return False\r\n    \r\n    # Check if student already booked this session\r\n    cur.execute('''\r\n        SELECT id FROM student_bookings \r\n        WHERE student_id = %s AND session_id = %s\r\n    ''', (student_id, session_id))\r\n    if cur.fetchone():\r\n        cur.close()\r\n        conn.close()\r\n        return False\r\n    \r\n    # Create booking\r\n    cur.execute('''\r\n        INSERT INTO student_bookings (student_id, session_id)\r\n        VALUES (%s, %s)\r\n    ''', (student_id, session_id))\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n    return True\r\n\r\ndef cancel_booking(booking_id, student_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('''\r\n        DELETE FROM student_bookings\r\n        WHERE id = %s AND student_id = %s\r\n    ''', (booking_id, student_id))\r\n    affected_rows = cur.rowcount\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n    return affected_rows > 0\r\n    \r\n\r\n\r\n@app.route('/video-conference')\r\ndef video_conference():\r\n    return render_template('live_session.html')  # We'll create this file next\r\n\r\n# Decorators\r\ndef login_required(f):\r\n    @wraps(f)\r\n    def decorated_function(*args, **kwargs):\r\n        if 'username' not in session:\r\n            flash('Please log in to access this page.', 'warning')\r\n            return redirect(url_for('login', next=request.url))\r\n        return f(*args, **kwargs)\r\n    return decorated_function\r\n\r\ndef admin_required(f):\r\n    @wraps(f)\r\n    def decorated_function(*args, **kwargs):\r\n        if 'role' not in session or session['role'] != 'admin':\r\n            return render_template('errors/403.html'), 403\r\n        return f(*args, **kwargs)\r\n    return decorated_function\r\n\r\n# Student session booking routes\r\n@app.route('/sessions/book/<int:session_id>', methods=['POST'])\r\n@login_required\r\ndef book_session_route(session_id):\r\n    if session.get('role') != 'student':\r\n        flash('Only students can book sessions', 'danger')\r\n        return redirect(url_for('view_sessions'))\r\n    \r\n    student_id = session.get('user_id')\r\n    if not student_id:\r\n        flash('User not properly authenticated', 'danger')\r\n        return redirect(url_for('view_sessions'))\r\n    \r\n    if book_session(student_id, session_id):\r\n        flash('Session booked successfully!', 'success')\r\n    else:\r\n        flash('Could not book session. It might be full or you already booked it.', 'danger')\r\n    return redirect(url_for('view_sessions'))\r\n\r\n@app.route('/sessions/cancel/<int:booking_id>', methods=['POST'])\r\n@login_required\r\ndef cancel_booking_route(booking_id):\r\n    if cancel_booking(booking_id, session.get('user_id')):\r\n        flash('Booking cancelled successfully', 'success')\r\n    else:\r\n        flash('Could not cancel booking', 'danger')\r\n    return redirect(url_for('view_sessions'))\r\n\r\n# Admin session management routes\r\n@app.route('/sessions')\r\n@login_required\r\ndef view_sessions():\r\n    student_id = session.get('user_id')\r\n    if not student_id:\r\n        flash('User not properly authenticated', 'danger')\r\n        return redirect(url_for('login'))\r\n    \r\n    sessions = get_all_sessions()\r\n    student_bookings = get_student_bookings(student_id)\r\n    return render_template('sessions/list.html', \r\n                         sessions=sessions, \r\n                         bookings=student_bookings)\r\n\r\n# Add this new route to app.py\r\n@app.route('/admin/sessions/bookings/<int:session_id>')\r\n@login_required\r\n@admin_required\r\ndef view_session_bookings(session_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    \r\n    # Get session details\r\n    cur.execute('SELECT title FROM tutorial_sessions WHERE id = %s', (session_id,))\r\n    session_title = cur.fetchone()[0]\r\n    \r\n    # Get users who booked this session\r\n    cur.execute('''\r\n        SELECT u.id, u.username \r\n        FROM student_bookings sb\r\n        JOIN users u ON sb.student_id = u.id\r\n        WHERE sb.session_id = %s\r\n    ''', (session_id,))\r\n    booked_users = cur.fetchall()\r\n    \r\n    cur.close()\r\n    conn.close()\r\n    \r\n    return render_template('admin/session_bookings.html', \r\n                         session_title=session_title,\r\n                         booked_users=booked_users)\r\n\r\n\r\n@app.route('/admin/sessions')\r\n@login_required\r\n@admin_required\r\ndef manage_sessions():\r\n    sessions = get_all_sessions()\r\n    upcoming_sessions = get_upcoming_sessions()\r\n    return render_template('admin/sessions.html', \r\n                         sessions=sessions,\r\n                         upcoming_sessions=upcoming_sessions)\r\n\r\n@app.route('/admin/sessions/add', methods=['GET', 'POST'])\r\n@login_required\r\n@admin_required\r\ndef add_session():\r\n    if request.method == 'POST':\r\n        title = request.form.get('title')\r\n        description = request.form.get('description')\r\n        start_time = request.form.get('start_time')\r\n        end_time = request.form.get('end_time')\r\n        max_students = request.form.get('max_students')\r\n        \r\n        try:\r\n            create_session(title, description, start_time, end_time, int(max_students))\r\n            flash('Session created successfully', 'success')\r\n            return redirect(url_for('manage_sessions'))\r\n        except Exception as e:\r\n            flash(f'Error creating session: {str(e)}', 'danger')\r\n    \r\n    return render_template('admin/add_session.html')\r\n\r\n@app.route('/admin/sessions/delete/<int:session_id>')\r\n@login_required\r\n@admin_required\r\ndef delete_session(session_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('DELETE FROM tutorial_sessions WHERE id = %s', (session_id,))\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n    flash('Session deleted successfully', 'success')\r\n    return redirect(url_for('manage_sessions'))\r\n\r\n# Add these helper functions\r\ndef get_all_videos():\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('''\r\n        SELECT tv.id, tv.title, tv.url, tc.name \r\n        FROM tutorial_videos tv\r\n        JOIN tutorial_categories tc ON tv.category_id = tc.id\r\n    ''')\r\n    videos = cur.fetchall()\r\n    cur.close()\r\n    conn.close()\r\n    return videos\r\n\r\ndef add_video(title, url, category_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('INSERT INTO tutorial_videos (title, url, category_id) VALUES (%s, %s, %s)',\r\n                (title, url, category_id))\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\ndef delete_video(video_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('DELETE FROM tutorial_videos WHERE id = %s', (video_id,))\r\n    conn.commit()\r\n    cur.close()\r\n    conn.close()\r\n\r\n@app.route('/admin/tutorials')\r\n@login_required\r\n@admin_required\r\ndef manage_tutorials():\r\n    videos = get_all_videos()  # This should return a list of videos\r\n    categories = get_all_categories()  # This should return a list of categories\r\n    \r\n    # Convert to the structure your template expects\r\n    tutorials_dict = {\r\n        category[1]: {  # category name as key\r\n            'videos': [v for v in videos if v[3] == category[1]],  # videos for this category\r\n            'id': category[0]  # category id\r\n        }\r\n        for category in categories\r\n    }\r\n    \r\n    return render_template('admin/tutorials.html', \r\n                         tutorials=tutorials_dict,\r\n                         videos=videos,\r\n                         categories=categories)\r\n\r\n@app.route('/admin/tutorials/add', methods=['GET', 'POST'])\r\n@login_required\r\n@admin_required\r\ndef add_tutorial():\r\n    if request.method == 'POST':\r\n        try:\r\n            title = request.form.get('title', '').strip()\r\n            url = request.form.get('url', '').strip()\r\n            category_id = request.form.get('category_id', '').strip()\r\n            \r\n            if not all([title, url, category_id]):\r\n                flash('All fields are required', 'danger')\r\n                return redirect(url_for('add_tutorial'))\r\n            \r\n            add_video(title, url, category_id)\r\n            flash('Tutorial added successfully', 'success')\r\n            return redirect(url_for('manage_tutorials'))\r\n            \r\n        except Exception as e:\r\n            flash(f'Error adding tutorial: {str(e)}', 'danger')\r\n            return redirect(url_for('add_tutorial'))\r\n    \r\n    # GET request - show the form\r\n    categories = get_all_categories()\r\n    return render_template('admin/add_tutorial.html', categories=categories)\r\n\r\n@app.route('/admin/tutorials/delete/<int:video_id>')\r\n@login_required\r\n@admin_required\r\ndef delete_tutorial(video_id):\r\n    delete_video(video_id)\r\n    flash('Tutorial video deleted successfully', 'success')\r\n    return redirect(url_for('manage_tutorials'))\r\n\r\n# Routes\r\n@app.route('/')\r\ndef home():\r\n    # Initialize subscription to None\r\n    subscription = None\r\n    # Check if user is logged in and 'user_id' is in session\r\n    if 'user_id' in session:\r\n        # Call the function and pass the result to the template\r\n        subscription = get_user_subscription(session['user_id'])\r\n\r\n    # Pass the subscription variable to the render_template function\r\n    return render_template('home.html', subscription=subscription)\r\n\r\n#Curriculums\r\n@app.route('/math-curriculum')\r\n@login_required\r\ndef math_curriculum():\r\n    return render_template('math_curriculum.html')\r\n\r\n@app.route('/science_curriculum')\r\n@login_required\r\ndef science_curriculum():\r\n    return render_template('science_curriculum.html')\r\n\r\n@app.route('/english_curriculum')\r\n@login_required\r\ndef english_curriculum():\r\n    return render_template('english_curriculum.html')\r\n\r\n@app.route('/login', methods=['GET', 'POST'])\r\ndef login():\r\n    if request.method == 'POST':\r\n        username = request.form['username']\r\n        password = request.form['password']\r\n\r\n        user = get_user_by_username(username)\r\n        if user and check_password_hash(user['password'], password):\r\n            session['username'] = username\r\n            session['user_id'] = user['id']\r\n            session['role'] = user['role']\r\n            session['class'] = user.get('class', 'default_class')  # Add this line\r\n            flash('Logged in successfully!', 'success')\r\n            return redirect(request.args.get('next') or url_for('home'))\r\n        else:\r\n            flash('Invalid username or password', 'danger')\r\n\r\n    return render_template('auth/login.html')\r\n\r\n@app.route('/logout')\r\ndef logout():\r\n    session.pop('username', None)\r\n    session.pop('role', None)\r\n    flash('You have been logged out.', 'info')\r\n    return redirect(url_for('home'))\r\n\r\n# @app.route('/tutorials')\r\n# @login_required\r\n# def tutorials_home():\r\n#     categories = get_all_categories()\r\n#     # Create a dictionary with category data\r\n#     tutorials_dict = {\r\n#         category[1]: {  # Using category name as key\r\n#             'id': category[0],  # category id\r\n#             'videos': get_videos_by_category(category[0])  # videos for this category\r\n#         }\r\n#         for category in categories\r\n#     }\r\n#     return render_template('tutorials/index.html', tutorials=tutorials_dict, categories=categories)\r\n\r\n@app.route('/tutorials')\r\n@login_required\r\ndef tutorials_home():\r\n    return render_template('tutorials/video_tutorials.html')\r\n\r\n@app.route('/study_guides')\r\n@login_required\r\ndef studyguides_home():\r\n    return render_template('study_guides.html')\r\n\r\n@app.route('/tutorials/<int:category_id>')\r\n@login_required\r\ndef tutorial_language(category_id):\r\n    videos = get_videos_by_category(category_id)\r\n    if not videos:\r\n        flash('Tutorial category not found', 'danger')\r\n        return redirect(url_for('tutorials_home'))\r\n    \r\n    # Get the category name\r\n    category_name = get_category_name(category_id)\r\n    \r\n    return render_template('tutorials/language.html', \r\n                         videos=videos,\r\n                         category={'id': category_id, 'name': category_name})\r\n\r\n# Admin dashboard\r\n@app.route('/admin')\r\n@login_required\r\n@admin_required\r\ndef admin_dashboard():\r\n    students = get_students()\r\n    categories = get_all_categories()\r\n    upcoming_sessions = get_upcoming_sessions()\r\n    \r\n    # Get active subscription count\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute(\"SELECT COUNT(*) FROM subscriptions WHERE is_active = TRUE\")\r\n    active_subscriptions_count = cur.fetchone()[0]\r\n    cur.close()\r\n    conn.close()\r\n    \r\n    return render_template('admin/dashboard.html', \r\n                         student_count=len(students), \r\n                         category_count=len(categories),\r\n                         upcoming_sessions=upcoming_sessions,\r\n                         active_subscriptions_count=active_subscriptions_count)\r\n\r\n@app.route('/admin/students')\r\n@login_required\r\n@admin_required\r\ndef manage_students():\r\n    students = get_students()\r\n    return render_template('admin/students.html', students=students)\r\n\r\n@app.route('/admin/students/add', methods=['GET', 'POST'])\r\n@login_required\r\n@admin_required\r\ndef add_student():\r\n    if request.method == 'POST':\r\n        username = request.form['username']\r\n        password = request.form['password']\r\n\r\n        existing_user = get_user_by_username(username)\r\n        if existing_user:\r\n            flash('Username already exists', 'danger')\r\n        else:\r\n            add_student_to_db(username, password)\r\n            flash('Student added successfully', 'success')\r\n            return redirect(url_for('manage_students'))\r\n\r\n    return render_template('admin/add_student.html')\r\n\r\n@app.route('/admin/students/delete/<int:student_id>')\r\n@login_required\r\n@admin_required\r\ndef delete_student(student_id):\r\n    delete_student_by_id(student_id)\r\n    flash('Student deleted successfully', 'success')\r\n    return redirect(url_for('manage_students'))\r\n\r\n@app.errorhandler(403)\r\ndef forbidden(e):\r\n    return render_template('errors/403.html'), 403\r\n\r\n# Student assignment routes\r\n@app.route('/assignments')\r\n@login_required\r\ndef view_assignments():\r\n    if session.get('role') != 'student':\r\n        flash('Only students can view assignments', 'danger')\r\n        return redirect(url_for('home'))\r\n    \r\n    assignments = get_assignments_for_user(session['user_id'])\r\n    return render_template('assignments/list.html', \r\n                         assignments=assignments,\r\n                         current_time=datetime.utcnow())\r\n\r\n@app.route('/assignments/<int:assignment_id>', methods=['GET', 'POST'])\r\n@login_required\r\ndef view_assignment(assignment_id):\r\n    if session.get('role') != 'student':\r\n        flash('Only students can view assignments', 'danger')\r\n        return redirect(url_for('home'))\r\n    \r\n    assignment = get_assignment_details(assignment_id)\r\n    if not assignment:\r\n        flash('Assignment not found', 'danger')\r\n        return redirect(url_for('view_assignments'))\r\n    \r\n    submission = get_student_submission(session['user_id'], assignment_id)\r\n    \r\n    if request.method == 'POST':\r\n        submission_text = request.form.get('submission_text', '')\r\n        file_path = None\r\n        \r\n        if 'assignment_file' in request.files:\r\n            file = request.files['assignment_file']\r\n            if file.filename != '':\r\n                filename = secure_filename(file.filename)\r\n                file_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)\r\n                os.makedirs(os.path.dirname(file_path), exist_ok=True)\r\n                file.save(file_path)\r\n        \r\n        if submit_assignment(assignment_id, session['user_id'], submission_text, file_path):\r\n            flash('Assignment submitted successfully!', 'success')\r\n            return redirect(url_for('view_assignment', assignment_id=assignment_id))\r\n        else:\r\n            flash('Error submitting assignment', 'danger')\r\n    \r\n    return render_template('assignments/view.html',\r\n                         assignment=assignment,\r\n                         submission=submission)\r\n# @login_required\r\n# def view_assignment(assignment_id):\r\n#     if session.get('role') != 'student':\r\n#         flash('Only students can view assignments', 'danger')\r\n#         return redirect(url_for('home'))\r\n    \r\n#     assignment = get_assignment_details(assignment_id)\r\n#     if not assignment:\r\n#         flash('Assignment not found', 'danger')\r\n#         return redirect(url_for('view_assignments'))\r\n    \r\n#     if request.method == 'POST':\r\n#         submission_text = request.form.get('submission_text', '')\r\n#         # Handle file upload if needed\r\n#         file_path = None\r\n#         if 'assignment_file' in request.files:\r\n#             file = request.files['assignment_file']\r\n#             if file.filename != '':\r\n#                 filename = secure_filename(file.filename)\r\n#                 file_path = os.path.join('uploads', filename)\r\n#                 file.save(os.path.join(app.static_folder, file_path))\r\n        \r\n#         if submit_assignment(assignment_id, session['user_id'], submission_text, file_path):\r\n#             flash('Assignment submitted successfully!', 'success')\r\n#         else:\r\n#             flash('Error submitting assignment', 'danger')\r\n#         return redirect(url_for('view_assignment', assignment_id=assignment_id))\r\n    \r\n#     return render_template('assignments/view.html', assignment=assignment)\r\n\r\n@app.route('/assignments/submissions')\r\n@login_required\r\ndef view_submissions():\r\n    if session.get('role') != 'student':\r\n        flash('Only students can view submissions', 'danger')\r\n        return redirect(url_for('home'))\r\n    \r\n    submissions = get_student_submissions(session['user_id'])\r\n    return render_template('assignments/submissions.html', submissions=submissions)\r\n\r\n@app.route('/admin/assignments/add', methods=['GET', 'POST'])\r\n@login_required\r\n@admin_required\r\ndef add_assignment_route():\r\n    if request.method == 'POST':\r\n        try:\r\n            # Get form data\r\n            title = request.form.get('title', '').strip()\r\n            description = request.form.get('description', '').strip()\r\n            subject = request.form.get('subject', '').strip()\r\n            total_marks = request.form.get('total_marks', '').strip()\r\n            deadline_str = request.form.get('deadline', '').strip()\r\n            assign_to = request.form.get('assign_to')  # 'all' or 'selected'\r\n            selected_users = request.form.getlist('selected_users[]') if assign_to == 'selected' else []\r\n\r\n            # Validate required fields\r\n            if not all([title, description, subject, total_marks, deadline_str]):\r\n                flash('All fields are required', 'danger')\r\n                return redirect(url_for('add_assignment_route'))\r\n\r\n            # Convert and validate total marks\r\n            try:\r\n                total_marks = int(total_marks)\r\n                if total_marks <= 0:\r\n                    flash('Total marks must be positive', 'danger')\r\n                    return redirect(url_for('add_assignment_route'))\r\n            except ValueError:\r\n                flash('Total marks must be a number', 'danger')\r\n                return redirect(url_for('add_assignment_route'))\r\n\r\n            # Validate deadline\r\n            try:\r\n                deadline = datetime.strptime(deadline_str, '%Y-%m-%dT%H:%M')\r\n                if deadline <= datetime.utcnow():\r\n                    flash('Deadline must be in the future', 'danger')\r\n                    return redirect(url_for('add_assignment_route'))\r\n            except ValueError:\r\n                flash('Invalid deadline format', 'danger')\r\n                return redirect(url_for('add_assignment_route'))\r\n\r\n            # Get user IDs based on selection\r\n            if assign_to == 'all':\r\n                conn = get_db_connection()\r\n                cur = conn.cursor()\r\n                cur.execute('SELECT id FROM users WHERE role = %s', ('student',))\r\n                user_ids = [row[0] for row in cur.fetchall()]\r\n                cur.close()\r\n                conn.close()\r\n            elif assign_to == 'selected' and selected_users:\r\n                user_ids = [int(user_id) for user_id in selected_users]\r\n            else:\r\n                flash('Please select at least one student', 'danger')\r\n                return redirect(url_for('add_assignment_route'))\r\n\r\n            # Create assignment\r\n            assignment_id = add_assignment(\r\n                title=title,\r\n                description=description,\r\n                subject=subject,\r\n                total_marks=total_marks,\r\n                deadline=deadline,\r\n                assigned_students_ids=user_ids\r\n            )\r\n\r\n            flash('Assignment created successfully!', 'success')\r\n            return redirect(url_for('manage_assignments'))\r\n\r\n        except Exception as e:\r\n            flash(f'Error creating assignment: {str(e)}', 'danger')\r\n            app.logger.error(f\"Assignment creation error: {str(e)}\")\r\n    \r\n    # GET request - show form with students\r\n    students = get_students()\r\n    return render_template('admin/assignments/add.html', students=students)\r\n    \r\n\r\n@app.route('/admin/assignments')\r\n@login_required\r\n@admin_required\r\ndef manage_assignments():\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('''\r\n            SELECT a.id, a.title, a.subject, a.deadline, a.total_marks, a.created_at,\r\n                   COUNT(au.user_id) as assigned_count,\r\n                   COUNT(s.id) as submission_count\r\n            FROM assignments a\r\n            LEFT JOIN assignment_users au ON a.id = au.assignment_id\r\n            LEFT JOIN assignment_submissions s ON a.id = s.assignment_id\r\n            GROUP BY a.id\r\n            ORDER BY a.deadline\r\n        ''')\r\n        \r\n        assignments = []\r\n        for row in cur.fetchall():\r\n            assignments.append({\r\n                'id': row[0],\r\n                'title': row[1],\r\n                'subject': row[2],\r\n                'deadline': row[3],\r\n                'total_marks': row[4],\r\n                'created_at': row[5],\r\n                'assigned_count': row[6],\r\n                'submission_count': row[7]\r\n            })\r\n        \r\n        return render_template('admin/assignments/list.html', assignments=assignments)\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\n@app.route('/admin/assignments/<int:assignment_id>/submissions')\r\n@login_required\r\n@admin_required\r\ndef view_assignment_submissions(assignment_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        # Get assignment details\r\n        cur.execute('SELECT id, title, total_marks FROM assignments WHERE id = %s', (assignment_id,))\r\n        assignment = cur.fetchone()\r\n        if not assignment:\r\n            flash('Assignment not found', 'danger')\r\n            return redirect(url_for('manage_assignments'))\r\n        \r\n        # Get submissions with student IDs\r\n        cur.execute('''\r\n            SELECT u.username, s.submitted_at, s.marks_obtained, u.id as student_id, s.feedback\r\n            FROM assignment_submissions s\r\n            JOIN users u ON s.student_id = u.id\r\n            WHERE s.assignment_id = %s\r\n            ORDER BY s.submitted_at DESC\r\n        ''', (assignment_id,))\r\n        submissions = cur.fetchall()\r\n        \r\n        return render_template('admin/assignments/submissions.html',\r\n                            assignment_title=assignment[1],\r\n                            assignment_id=assignment_id,\r\n                            submissions=submissions)\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\n@app.route('/dashboard')\r\n@login_required\r\ndef dashboard():\r\n    try:\r\n        # Get the user's class from session or database\r\n        user_class = session.get('class')  # Make sure this is set during login\r\n        \r\n        conn = get_db_connection()\r\n        cur = conn.cursor()\r\n        cur.execute('''\r\n            SELECT id, title, subject, deadline, total_marks\r\n            FROM assignments\r\n            WHERE class = %s\r\n            ORDER BY deadline\r\n        ''', (user_class,))\r\n        assignments = cur.fetchall()\r\n        cur.close()\r\n        conn.close()\r\n        \r\n        return render_template(\r\n            'dashboard.html',\r\n            assignments=assignments,\r\n            current_time=datetime.utcnow()\r\n        )\r\n    except Exception as e:\r\n        app.logger.error(f\"Error fetching assignments: {str(e)}\")\r\n        return render_template('dashboard.html', \r\n                            assignments=[], \r\n                            current_time=datetime.utcnow())\r\n    \r\n# Add these new routes to app.py\r\n@app.route('/admin/assignments/<int:assignment_id>/submissions/<int:student_id>/grade', methods=['GET', 'POST'])\r\n@login_required\r\n@admin_required\r\ndef grade_submission(assignment_id, student_id):\r\n    # Get student details\r\n    student = get_user_by_id(student_id)\r\n    if not student:\r\n        flash('Student not found', 'danger')\r\n        return redirect(url_for('view_assignment_submissions', assignment_id=assignment_id))\r\n    \r\n    # Get submission and assignment details\r\n    data = get_submission_for_grading(assignment_id, student_id)\r\n    if not data:\r\n        flash('Submission not found', 'danger')\r\n        return redirect(url_for('view_assignment_submissions', assignment_id=assignment_id))\r\n    \r\n    if request.method == 'POST':\r\n        marks_obtained = request.form.get('marks_obtained')\r\n        feedback = request.form.get('feedback', '')\r\n        \r\n        try:\r\n            marks_obtained = float(marks_obtained)\r\n            if marks_obtained < 0 or marks_obtained > data['assignment']['total_marks']:\r\n                flash('Invalid marks value', 'danger')\r\n                return redirect(url_for('grade_submission', assignment_id=assignment_id, student_id=student_id))\r\n            \r\n            if update_submission_grade(assignment_id, student_id, marks_obtained, feedback):\r\n                flash('Grade submitted successfully', 'success')\r\n                return redirect(url_for('view_assignment_submissions', assignment_id=assignment_id))\r\n            else:\r\n                flash('Error submitting grade', 'danger')\r\n        except ValueError:\r\n            flash('Invalid marks format', 'danger')\r\n    \r\n    return render_template('admin/assignments/grade.html',\r\n                         assignment_id=assignment_id,\r\n                         student=student,\r\n                         submission=data['submission'],\r\n                         assignment=data['assignment'])\r\n\r\n@app.route('/admin/assignments/<int:assignment_id>/submissions/<int:student_id>/submit-grade', methods=['POST'])\r\n@login_required\r\n@admin_required\r\ndef submit_grade(assignment_id, student_id):\r\n    marks_obtained = request.form.get('marks_obtained')\r\n    feedback = request.form.get('feedback', '')\r\n    \r\n    try:\r\n        marks_obtained = float(marks_obtained)\r\n        \r\n        # Get assignment to validate max marks\r\n        assignment = get_assignment_details(assignment_id)\r\n        if not assignment:\r\n            flash('Assignment not found', 'danger')\r\n            return redirect(url_for('manage_assignments'))\r\n        \r\n        if marks_obtained < 0 or marks_obtained > assignment[4]:  # total_marks is at index 4\r\n            flash('Invalid marks value', 'danger')\r\n            return redirect(url_for('grade_submission', assignment_id=assignment_id, student_id=student_id))\r\n        \r\n        if update_submission_grade(assignment_id, student_id, marks_obtained, feedback):\r\n            flash('Grade submitted successfully', 'success')\r\n        else:\r\n            flash('Error submitting grade', 'danger')\r\n    except ValueError:\r\n        flash('Invalid marks format', 'danger')\r\n    \r\n    return redirect(url_for('view_assignment_submissions', assignment_id=assignment_id))\r\n\r\n#Leaderboard routes\r\n@app.route('/leaderboard')\r\n@login_required\r\ndef view_leaderboard():\r\n    subject = request.args.get('subject')\r\n    topic = request.args.get('topic')\r\n    time_period = request.args.get('time', 'all')\r\n    \r\n    leaderboard, user_stats, user_rank = get_leaderboard(\r\n        subject=subject, \r\n        topic=topic, \r\n        time_period=time_period\r\n    )\r\n    \r\n    # Get available subjects and topics\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    cur.execute('SELECT DISTINCT subject FROM practice_scores ORDER BY subject')\r\n    available_subjects = [row[0] for row in cur.fetchall()]\r\n    \r\n    available_topics = []\r\n    if subject:\r\n        cur.execute('''\r\n            SELECT DISTINCT topic FROM practice_scores \r\n            WHERE subject = %s ORDER BY topic\r\n        ''', (subject,))\r\n        available_topics = [row[0] for row in cur.fetchall()]\r\n    \r\n    cur.close()\r\n    conn.close()\r\n    \r\n    return render_template('leaderboard.html',\r\n                         leaderboard=leaderboard,\r\n                         available_subjects=available_subjects,\r\n                         available_topics=available_topics,\r\n                         current_subject=subject,\r\n                         current_topic=topic,\r\n                         user_stats=user_stats,\r\n                         user_rank=user_rank)\r\n\r\n@app.route('/api/leaderboard-details')\r\n@login_required\r\ndef get_leaderboard_details():\r\n    user_id = request.args.get('user_id')\r\n    \r\n    if not user_id:\r\n        return jsonify({'error': 'Missing user_id parameter'}), 400\r\n    \r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    \r\n    try:\r\n        # Get basic user info\r\n        cur.execute('SELECT username FROM users WHERE id = %s', (user_id,))\r\n        user = cur.fetchone()\r\n        if not user:\r\n            return jsonify({'error': 'User not found'}), 404\r\n        \r\n        # Get overall stats (total score / attempts)\r\n        cur.execute('''\r\n            SELECT \r\n                ROUND(SUM(score)::numeric / COUNT(id), 2) as avg_score,\r\n                COUNT(*) as attempt_count,\r\n                ROUND(AVG(score::numeric / total_questions * 100), 2) as avg_percentage\r\n            FROM practice_scores\r\n            WHERE student_id = %s\r\n        ''', (user_id,))\r\n        overall_stats = cur.fetchone()\r\n        \r\n        # Get global rank based on (total score / attempts)\r\n        cur.execute('''\r\n            WITH ranked_students AS (\r\n                SELECT \r\n                    student_id,\r\n                    SUM(score)::numeric / COUNT(id) as avg_score,\r\n                    DENSE_RANK() OVER (ORDER BY (SUM(score)::numeric / COUNT(id)) DESC) as rank\r\n                FROM practice_scores\r\n                GROUP BY student_id\r\n            )\r\n            SELECT rank \r\n            FROM ranked_students\r\n            WHERE student_id = %s\r\n        ''', (user_id,))\r\n        rank_result = cur.fetchone()\r\n        \r\n        # Get performance by subject\r\n        cur.execute('''\r\n            SELECT \r\n                subject,\r\n                ROUND(SUM(score)::numeric / COUNT(id), 2) as avg_score,\r\n                COUNT(*) as attempt_count,\r\n                ROUND(AVG(score::numeric / total_questions * 100), 2) as avg_percentage\r\n            FROM practice_scores\r\n            WHERE student_id = %s\r\n            GROUP BY subject\r\n            ORDER BY avg_score DESC\r\n        ''', (user_id,))\r\n        subjects = []\r\n        for row in cur.fetchall():\r\n            subjects.append({\r\n                'subject': row[0],\r\n                'avg_score': row[1],\r\n                'attempt_count': row[2],\r\n                'avg_percentage': row[3]\r\n            })\r\n        \r\n        # Get history for chart\r\n        cur.execute('''\r\n            SELECT \r\n                score,\r\n                total_questions,\r\n                ROUND((score::numeric / total_questions * 100), 2) as percentage,\r\n                completed_at,\r\n                subject,\r\n                topic\r\n            FROM practice_scores\r\n            WHERE student_id = %s\r\n            ORDER BY completed_at\r\n        ''', (user_id,))\r\n        \r\n        history = []\r\n        for row in cur.fetchall():\r\n            history.append({\r\n                'score': row[0],\r\n                'total_questions': row[1],\r\n                'percentage': row[2],\r\n                'date': row[3].strftime('%Y-%m-%d'),\r\n                'subject': row[4],\r\n                'topic': row[5]\r\n            })\r\n        \r\n        return jsonify({\r\n            'username': user[0],\r\n            'avg_score': overall_stats[0] if overall_stats else 0,\r\n            'attempt_count': overall_stats[1] if overall_stats else 0,\r\n            'avg_percentage': overall_stats[2] if overall_stats else 0,\r\n            'rank': rank_result[0] if rank_result else None,\r\n            'subjects': subjects,\r\n            'history': history\r\n        })\r\n        \r\n    except Exception as e:\r\n        print(f\"Error getting leaderboard details: {e}\")\r\n        return jsonify({'error': 'Internal server error'}), 500\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\n@app.route('/api/record-practice', methods=['POST'])\r\n@login_required\r\ndef record_practice():\r\n    if session.get('role') != 'student':\r\n        return jsonify({'success': False, 'error': 'Only students can record practice'})\r\n    \r\n    data = request.get_json()\r\n    subject = data.get('subject')\r\n    topic = data.get('topic')\r\n    score = data.get('score')\r\n    total_questions = data.get('total_questions')\r\n    \r\n    if not all([subject, topic, score is not None, total_questions]):\r\n        return jsonify({'success': False, 'error': 'Missing required fields'})\r\n    \r\n    try:\r\n        success = record_practice_score(\r\n            student_id=session['user_id'],\r\n            subject=subject,\r\n            topic=topic,\r\n            score=score,\r\n            total_questions=total_questions\r\n        )\r\n        return jsonify({'success': success})\r\n    except Exception as e:\r\n        return jsonify({'success': False, 'error': str(e)})\r\n    \r\n# Subscription routes\r\n@app.route('/subscribe')\r\n@login_required\r\ndef subscribe():\r\n    plans = get_subscription_plans()\r\n    current_sub = get_user_subscription(session['user_id'])\r\n    return render_template('subscriptions/subscribe.html', \r\n                         plans=plans,\r\n                         current_sub=current_sub)\r\n\r\n@app.route('/subscribe/<int:plan_id>', methods=['POST'])\r\n@login_required\r\ndef create_subscription(plan_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    \r\n    try:\r\n        # Get plan details\r\n        cur.execute('SELECT id, price, duration_days FROM subscription_plans WHERE id = %s', (plan_id,))\r\n        plan = cur.fetchone()\r\n        if not plan:\r\n            flash('Invalid subscription plan', 'danger')\r\n            return redirect(url_for('subscribe'))\r\n        \r\n        # Create subscription (payment will be marked as pending)\r\n        start_date = datetime.utcnow()\r\n        end_date = start_date + timedelta(days=plan[2])\r\n        \r\n        cur.execute('''\r\n            INSERT INTO subscriptions \r\n            (user_id, plan_id, start_date, end_date, is_active, payment_status)\r\n            VALUES (%s, %s, %s, %s, %s, %s)\r\n            RETURNING id\r\n        ''', (session['user_id'], plan_id, start_date, end_date, False, 'pending'))\r\n        \r\n        subscription_id = cur.fetchone()[0]\r\n        conn.commit()\r\n        \r\n        # In a real app, you would integrate with a payment gateway here\r\n        # For now, we'll just redirect to a confirmation page\r\n        return redirect(url_for('subscription_confirmation', subscription_id=subscription_id))\r\n        \r\n    except Exception as e:\r\n        conn.rollback()\r\n        flash('Error creating subscription: ' + str(e), 'danger')\r\n        return redirect(url_for('subscribe'))\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\n@app.route('/subscription/confirmation/<int:subscription_id>')\r\n@login_required\r\ndef subscription_confirmation(subscription_id):\r\n    return render_template('subscriptions/confirmation.html', subscription_id=subscription_id)\r\n\r\n# Admin subscription management\r\n@app.route('/admin/subscriptions')\r\n@login_required\r\n@admin_required\r\ndef manage_subscriptions():\r\n    subscriptions = get_all_subscriptions()\r\n    return render_template('admin/subscriptions/list.html', subscriptions=subscriptions)\r\n\r\n@app.route('/admin/subscriptions/mark-paid/<int:subscription_id>', methods=['POST'])\r\n@login_required\r\n@admin_required\r\ndef mark_subscription_paid(subscription_id):\r\n    if mark_subscription_as_paid(subscription_id):\r\n        flash('Subscription marked as paid', 'success')\r\n    else:\r\n        flash('Failed to mark subscription as paid', 'danger')\r\n    return redirect(url_for('manage_subscriptions'))\r\n\r\n# Add this new route to app.py\r\n@app.route('/admin/subscriptions/add', methods=['GET', 'POST'])\r\n@login_required\r\n@admin_required\r\ndef admin_add_subscription():\r\n    if request.method == 'POST':\r\n        try:\r\n            student_id = request.form.get('student_id')\r\n            plan_id = request.form.get('plan_id')\r\n            start_date_str = request.form.get('start_date')\r\n            duration_days = request.form.get('duration_days')\r\n            mark_paid = request.form.get('mark_paid') is not None # Checkbox value\r\n\r\n            if not all([student_id, plan_id, start_date_str, duration_days]):\r\n                flash('All fields are required', 'danger')\r\n                return redirect(url_for('admin_add_subscription'))\r\n\r\n            # Convert data types\r\n            student_id = int(student_id)\r\n            plan_id = int(plan_id)\r\n            duration_days = int(duration_days)\r\n            start_date = datetime.strptime(start_date_str, '%Y-%m-%d')\r\n            end_date = start_date + timedelta(days=duration_days)\r\n\r\n            # Determine payment status and active status\r\n            payment_status = 'paid' if mark_paid else 'pending'\r\n            is_active = mark_paid # Subscription is active immediately if marked as paid\r\n\r\n            subscription_id = add_subscription_to_db(\r\n                user_id=student_id,\r\n                plan_id=plan_id,\r\n                start_date=start_date,\r\n                end_date=end_date,\r\n                is_active=is_active,\r\n                payment_status=payment_status\r\n            )\r\n\r\n            if subscription_id:\r\n                # If marked paid, update user role if necessary (e.g., grant premium access)\r\n                if is_active:\r\n                     conn = get_db_connection()\r\n                     cur = conn.cursor()\r\n                     try:\r\n                         cur.execute('SELECT name FROM subscription_plans WHERE id = %s', (plan_id,))\r\n                         plan_name = cur.fetchone()[0]\r\n                         if plan_name.lower() == 'premium': # Check plan name for role update\r\n                             cur.execute(\"UPDATE users SET role = 'premium' WHERE id = %s\", (student_id,))\r\n                             conn.commit()\r\n                     except Exception as e:\r\n                         print(f\"Error updating user role: {e}\")\r\n                     finally:\r\n                         cur.close()\r\n                         conn.close()\r\n\r\n                flash('Subscription added successfully', 'success')\r\n                return redirect(url_for('manage_subscriptions'))\r\n            else:\r\n                flash('Error adding subscription', 'danger')\r\n\r\n        except ValueError:\r\n            flash('Invalid input data', 'danger')\r\n        except Exception as e:\r\n            flash(f'An unexpected error occurred: {str(e)}', 'danger')\r\n            app.logger.error(f\"Admin add subscription error: {str(e)}\")\r\n\r\n\r\n    # GET request\r\n    students = get_students()\r\n    plans = get_subscription_plans()\r\n    print(\"DEBUG: Rendering admin/add_subscription.html. Checking if 'float' is in globals:\", 'float' in app.jinja_env.globals) # Add this line\r\n    return render_template('admin/add_subscription.html', students=students, plans=plans)\r\n\r\n@app.route('/subscription/status')\r\n@login_required\r\ndef subscription_status():\r\n    # Ensure only students can access this page if needed, although login_required already restricts it\r\n    if session.get('role') != 'student':\r\n        flash('This page is only for students.', 'warning')\r\n        return redirect(url_for('home')) # Or wherever appropriate\r\n\r\n    user_id = session.get('user_id')\r\n    if not user_id:\r\n        # This case should be covered by @login_required, but as a fallback:\r\n        flash('User not logged in.', 'danger')\r\n        return redirect(url_for('login'))\r\n\r\n    subscription = get_user_subscription(user_id)\r\n    return render_template('subscription_status.html', subscription=subscription)\r\n\r\n@app.route('/exam_practice')\r\n@login_required # Assuming exam practice requires login\r\n# @student_required # Optional: if only students should access\r\ndef exam_practice():\r\n    \"\"\"Renders the exam practice page with data from exams.json.\"\"\"\r\n    exams = load_exams_from_json('static/js/exams.json') # Adjust path if needed\r\n    print(\"DEBUG: Loaded exams:\", exams)\r\n    return render_template('exam_practice.html', exams=exams)\r\n\r\n@app.route('/exam/<int:exam_id>')\r\n@login_required # Ensure user is logged in to take exams\r\n# @student_required # Optional: restrict to students\r\ndef take_exam(exam_id):\r\n    \"\"\"Loads a specific exam and renders the exam-taking page.\"\"\"\r\n    exams = load_exams_from_json('static/js/exams.json') # Load all exams\r\n\r\n    # Find the exam with the matching ID\r\n    selected_exam = None\r\n    for exam in exams:\r\n        if exam.get('id') == exam_id:\r\n            selected_exam = exam\r\n            break\r\n\r\n    if selected_exam:\r\n        return render_template('take_exam.html', exam=selected_exam)\r\n    else:\r\n        flash('Exam not found.', 'danger')\r\n        return redirect(url_for('exam_practice')) # Redirect back if exam ID is invalid\r\n\r\n@app.route('/submit_exam/<int:exam_id>', methods=['POST'])\r\n@login_required # Ensure user is logged in\r\n# @student_required # Optional: restrict to students\r\ndef submit_exam(exam_id):\r\n    \"\"\"Handles the submission of an exam, grades it, and saves the result.\"\"\"\r\n    user_id = session.get('user_id')\r\n    if not user_id:\r\n        flash('User not logged in.', 'danger')\r\n        return redirect(url_for('login'))\r\n\r\n    # Load all exams from the JSON file\r\n    exams = load_exams_from_json('static/js/exams.json')\r\n\r\n    # Find the specific exam the user submitted\r\n    selected_exam = None\r\n    for exam in exams:\r\n        if exam.get('id') == exam_id:\r\n            selected_exam = exam\r\n            break\r\n\r\n    if not selected_exam:\r\n        flash('Exam not found.', 'danger')\r\n        return redirect(url_for('exam_practice')) # Redirect back if exam ID is invalid\r\n\r\n    # Get user's submitted answers\r\n    user_answers = request.form\r\n\r\n    # Grade the exam\r\n    correct_answers_count = 0\r\n    total_questions = len(selected_exam.get('questions', []))\r\n\r\n    if total_questions > 0:\r\n        for question in selected_exam.get('questions', []):\r\n            question_id_key = f\"question_{question.get('id')}\"\r\n            submitted_answer = user_answers.get(question_id_key)\r\n            correct_answer = question.get('correct_answer')\r\n\r\n            # Compare submitted answer with the correct answer\r\n            # Ensure comparison handles potential data type differences if necessary\r\n            if submitted_answer is not None and str(submitted_answer) == str(correct_answer):\r\n                correct_answers_count += 1\r\n\r\n        # Calculate score (as a percentage)\r\n        score = (correct_answers_count / total_questions) * 100\r\n    else:\r\n        score = 0 # Handle exams with no questions\r\n\r\n    print(f\"User {user_id} submitted Exam {exam_id}. Score: {score:.2f}% ({correct_answers_count}/{total_questions} correct)\")\r\n\r\n    # Save the result to the database\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    result_id = None\r\n    try:\r\n        cur.execute('''\r\n            INSERT INTO exam_results (user_id, exam_id, score, total_questions, completion_time)\r\n            VALUES (%s, %s, %s, %s, CURRENT_TIMESTAMP)\r\n            RETURNING id;\r\n        ''', (user_id, exam_id, score, total_questions))\r\n        result_id = cur.fetchone()[0]\r\n        conn.commit()\r\n        flash('Exam submitted and graded successfully!', 'success')\r\n\r\n        # Redirect to a results page\r\n        return redirect(url_for('exam_results', result_id=result_id))\r\n\r\n    except Exception as e:\r\n        conn.rollback()\r\n        print(f\"Error saving exam result: {e}\")\r\n        flash('Error saving exam result.', 'danger')\r\n        # Redirect to exam practice page or an error page\r\n        return redirect(url_for('exam_practice'))\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\n# *** Placeholder route for displaying exam results ***\r\n# You will implement the logic for this route and create the template next.\r\n\r\n# Placeholder route for displaying exam results\r\n@app.route('/exam_results/<int:result_id>')\r\n@login_required\r\ndef exam_results(result_id):\r\n    \"\"\"Fetches and displays the results of a completed exam.\"\"\"\r\n    user_id = session.get('user_id')\r\n    if not user_id:\r\n        flash('User not logged in.', 'danger')\r\n        return redirect(url_for('login'))\r\n\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    result = None\r\n    try:\r\n        # Fetch the specific exam result from the database\r\n        cur.execute('''\r\n            SELECT id, user_id, exam_id, score, total_questions, completion_time\r\n            FROM exam_results\r\n            WHERE id = %s AND user_id = %s; -- Ensure user can only see their own results\r\n        ''', (result_id, user_id))\r\n        result = cur.fetchone()\r\n\r\n    except Exception as e:\r\n        print(f\"Error fetching exam result {result_id}: {e}\")\r\n        flash('Error fetching exam results.', 'danger')\r\n        return redirect(url_for('exam_practice')) # Redirect if fetching fails\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\n    if not result:\r\n        flash('Exam result not found or you do not have permission to view it.', 'danger')\r\n        return redirect(url_for('exam_practice')) # Redirect if result not found\r\n\r\n    # Unpack result data\r\n    result_id, result_user_id, exam_json_id, score, total_questions, completion_time = result\r\n\r\n    # Load the exam details from the JSON file using the exam_json_id\r\n    exams = load_exams_from_json('static/js/exams.json')\r\n    exam_details = None\r\n    for exam in exams:\r\n        if exam.get('id') == exam_json_id:\r\n            exam_details = exam\r\n            break\r\n\r\n    if not exam_details:\r\n         # This case means the exam data in the JSON was changed/removed after the user took it\r\n        flash(f'Exam details for result ID {result_id} not found in JSON file.', 'warning')\r\n        # We can still show the basic score, but not question-by-question review\r\n        return render_template('exam_results.html',\r\n                               result=result, # Pass the basic result data\r\n                               exam_details=None) # Indicate exam details are missing\r\n\r\n\r\n    # Pass both the result data and exam details to the template\r\n    return render_template('exam_results.html',\r\n                           result=result,\r\n                           exam_details=exam_details)\r\n\r\n# Announcement routes\r\n@app.route('/announcements')\r\n@login_required\r\ndef view_announcements():\r\n    announcements = get_user_announcements(session['user_id'])\r\n    return render_template('announcements/list.html', announcements=announcements)\r\n\r\n@app.route('/announcements/<int:announcement_id>')\r\n@login_required\r\ndef view_announcement(announcement_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        # Get the announcement and mark it as read\r\n        cur.execute('''\r\n            SELECT a.id, a.title, a.message, a.created_at, u.username as created_by\r\n            FROM announcements a\r\n            JOIN users u ON a.created_by = u.id\r\n            JOIN user_announcements ua ON a.id = ua.announcement_id\r\n            WHERE ua.user_id = %s AND a.id = %s\r\n        ''', (session['user_id'], announcement_id))\r\n        \r\n        announcement = cur.fetchone()\r\n        if not announcement:\r\n            flash('Announcement not found', 'danger')\r\n            return redirect(url_for('view_announcements'))\r\n            \r\n        # Mark as read\r\n        mark_announcement_read(announcement_id, session['user_id'])\r\n        \r\n        return render_template('announcements/view.html', announcement={\r\n            'id': announcement[0],\r\n            'title': announcement[1],\r\n            'message': announcement[2],\r\n            'created_at': announcement[3],\r\n            'created_by': announcement[4]\r\n        })\r\n    except Exception as e:\r\n        flash('Error viewing announcement', 'danger')\r\n        return redirect(url_for('view_announcements'))\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n\r\n# Admin announcement management\r\n@app.route('/admin/announcements')\r\n@login_required\r\n@admin_required\r\ndef manage_announcements():\r\n    announcements = get_all_announcements()\r\n    return render_template('admin/announcements/list.html', announcements=announcements)\r\n\r\n@app.route('/admin/announcements/add', methods=['GET', 'POST'])\r\n@login_required\r\n@admin_required\r\ndef add_announcement():\r\n    if request.method == 'POST':\r\n        title = request.form.get('title', '').strip()\r\n        message = request.form.get('message', '').strip()\r\n        send_to = request.form.getlist('send_to')  # List of user IDs or 'all'\r\n        \r\n        if not title or not message:\r\n            flash('Title and message are required', 'danger')\r\n            return redirect(url_for('add_announcement'))\r\n            \r\n        try:\r\n            # If \"all\" is selected, send to all students\r\n            user_ids = None if 'all' in send_to else [int(user_id) for user_id in send_to]\r\n            \r\n            create_announcement(\r\n                title=title,\r\n                message=message,\r\n                created_by=session['user_id'],\r\n                user_ids=user_ids\r\n            )\r\n            \r\n            flash('Announcement created successfully!', 'success')\r\n            return redirect(url_for('manage_announcements'))\r\n        except Exception as e:\r\n            flash(f'Error creating announcement: {str(e)}', 'danger')\r\n            return redirect(url_for('add_announcement'))\r\n    \r\n    # GET request - show form\r\n    students = get_students()\r\n    return render_template('admin/announcements/add.html', students=students)\r\n\r\n\r\n@app.route('/admin/announcements/delete/<int:announcement_id>', methods=['POST'])\r\n@login_required\r\n@admin_required\r\ndef delete_announcement(announcement_id):\r\n    conn = get_db_connection()\r\n    cur = conn.cursor()\r\n    try:\r\n        cur.execute('DELETE FROM announcements WHERE id = %s', (announcement_id,))\r\n        conn.commit()\r\n        flash('Announcement deleted successfully', 'success')\r\n    except Exception as e:\r\n        conn.rollback()\r\n        flash('Error deleting announcement', 'danger')\r\n    finally:\r\n        cur.close()\r\n        conn.close()\r\n    return redirect(url_for('manage_announcements'))\r\n\r\n@app.route('/admin/assignments/import', methods=['GET', 'POST'])\r\n@login_required\r\n@admin_required\r\ndef import_assignments():\r\n    if request.method == 'POST':\r\n        if 'json_file' not in request.files:\r\n            flash('No file selected', 'danger')\r\n            return redirect(request.url)\r\n        \r\n        file = request.files['json_file']\r\n        if file.filename == '':\r\n            flash('No file selected', 'danger')\r\n            return redirect(request.url)\r\n        \r\n        if file and file.filename.endswith('.json'):\r\n            try:\r\n                data = json.load(file)\r\n                \r\n                # Handle both single assignment and array of assignments\r\n                assignments_data = data if isinstance(data, list) else [data]\r\n                \r\n                for assignment_data in assignments_data:\r\n                    # Validate required fields\r\n                    required_fields = ['title', 'description', 'subject', 'total_marks', 'deadline']\r\n                    if not all(field in assignment_data for field in required_fields):\r\n                        flash('Invalid JSON structure - missing required fields', 'danger')\r\n                        continue\r\n                    \r\n                    try:\r\n                        # Convert deadline string to datetime\r\n                        deadline = datetime.strptime(assignment_data['deadline'], '%Y-%m-%d %H:%M')\r\n                    except ValueError:\r\n                        flash('Invalid deadline format in JSON (use YYYY-MM-DD HH:MM)', 'danger')\r\n                        continue\r\n                    \r\n                    # Get assigned users (default to all students if not specified)\r\n                    assigned_users = assignment_data.get('assigned_users', 'all')\r\n                    \r\n                    # Get the interactive content if provided\r\n                    content = assignment_data.get('content', '')\r\n                    \r\n                    # Create assignment with the interactive content\r\n                    assignment_id = add_assignment(\r\n                        title=assignment_data['title'],\r\n                        description=assignment_data['description'],\r\n                        subject=assignment_data['subject'],\r\n                        total_marks=int(assignment_data['total_marks']),\r\n                        deadline=deadline,\r\n                        assigned_students_ids=assigned_users if assigned_users != 'all' else None\r\n                    )\r\n                    \r\n                    # If there's interactive content, store it in the database\r\n                    if content:\r\n                        conn = get_db_connection()\r\n                        cur = conn.cursor()\r\n                        try:\r\n                            cur.execute('''\r\n                                UPDATE assignments \r\n                                SET content = %s \r\n                                WHERE id = %s\r\n                            ''', (content, assignment_id))\r\n                            conn.commit()\r\n                        except Exception as e:\r\n                            conn.rollback()\r\n                            print(f\"Error saving interactive content: {e}\")\r\n                        finally:\r\n                            cur.close()\r\n                            conn.close()\r\n                \r\n                flash(f'Successfully imported {len(assignments_data)} assignments', 'success')\r\n                return redirect(url_for('manage_assignments'))\r\n                \r\n            except json.JSONDecodeError:\r\n                flash('Invalid JSON file', 'danger')\r\n            except Exception as e:\r\n                flash(f'Error importing assignments: {str(e)}', 'danger')\r\n        \r\n        else:\r\n            flash('Only JSON files are allowed', 'danger')\r\n    \r\n    # GET request - show import form\r\n    return render_template('admin/assignments/import.html')\r\n\r\n@app.context_processor\r\ndef inject_functions():\r\n    return dict(get_unread_announcements_count=get_unread_announcements_count)\r\n    \r\n    \r\nif __name__ == '__main__':\r\n    from waitress import serve\r\n    initialize_database()\r\n    serve(app, host=\"0.0.0.0\", port=5000)\r\n\r\n# if __name__ == '__main__':\r\n#     # Enable Flask debug features\r\n#     app.debug = True  # Enables auto-reloader and debugger\r\n    \r\n#     # Initialize database\r\n#     initialize_database()\r\n    \r\n#     # Run the development server\r\n#     app.run(host='0.0.0.0', port=5000)\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app.py b/app.py
--- a/app.py	(revision bc58233865f924ee39b4e82a7e1e080720bdd4b5)
+++ b/app.py	(date 1747837133741)
@@ -9,6 +9,12 @@
 from flask import render_template
 from flask_login import current_user, login_required
 import json
+from flask import Flask, request, jsonify
+import uuid
+from flask_socketio import SocketIO, emit, join_room
+from flask_wtf import FlaskForm
+from wtforms import StringField, SubmitField
+from wtforms.validators import DataRequired
 
 # Load environment variables
 load_dotenv()
@@ -19,6 +25,13 @@
 app.secret_key = os.environ.get('FLASK_SECRET_KEY', 'fallback-secret-key-for-development')
 app.jinja_env.globals.update(float=float)
 
+# Initialize SocketIO
+socketio = SocketIO(app)
+
+class CreateWhiteboardForm(FlaskForm):
+    name = StringField('Whiteboard Name', validators=[DataRequired()])
+    submit = SubmitField('Create Whiteboard')
+
 
 # Configure upload folder in your app
 UPLOAD_FOLDER = os.path.join('static', 'uploads')
@@ -39,7 +52,7 @@
             port=os.getenv('5432'),
             # sslmode='require'
         )
-        print("✅ Successfully connected to Supabase!")
+        print("✅ Successfully connected to Database!")
         return conn
     except Exception as e:
         print(f"❌ Connection failed: {e}")
@@ -53,6 +66,36 @@
     conn = get_db_connection()
     cur = conn.cursor()
 
+     # Add this with your other table creations
+    cur.execute('''
+        CREATE TABLE IF NOT EXISTS whiteboards (
+            id UUID PRIMARY KEY,
+            name VARCHAR(255),
+            created_by INTEGER REFERENCES users(id),
+            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
+        )
+    ''')
+    
+    cur.execute('''
+        CREATE TABLE IF NOT EXISTS whiteboard_elements (
+            id SERIAL PRIMARY KEY,
+            whiteboard_id UUID REFERENCES whiteboards(id) ON DELETE CASCADE,
+            type VARCHAR(50) NOT NULL,
+            data JSONB NOT NULL,
+            created_by INTEGER REFERENCES users(id),
+            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
+        )
+    ''')
+    
+    cur.execute('''
+        CREATE TABLE IF NOT EXISTS whiteboard_participants (
+            whiteboard_id UUID REFERENCES whiteboards(id) ON DELETE CASCADE,
+            user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
+            joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
+            PRIMARY KEY (whiteboard_id, user_id)
+        )
+    ''')
+
     # Add this after your other table creations
     cur.execute('''
         CREATE TABLE IF NOT EXISTS announcements (
@@ -267,7 +310,163 @@
     cur.close()
     conn.close()
 
-# Helpers
+# Helper
+@socketio.on('join_whiteboard')
+def handle_join_whiteboard(data):
+    whiteboard_id = data.get('whiteboard_id')
+    user_id = session.get('user_id')
+    
+    if not whiteboard_id or not user_id:
+        return
+    
+    # Add user to participants if not already there
+    conn = get_db_connection()
+    cur = conn.cursor()
+    try:
+        cur.execute('''
+            INSERT INTO whiteboard_participants (whiteboard_id, user_id)
+            VALUES (%s, %s)
+            ON CONFLICT DO NOTHING
+        ''', (whiteboard_id, user_id))
+        conn.commit()
+        
+        # Get username
+        cur.execute('SELECT username FROM users WHERE id = %s', (user_id,))
+        username = cur.fetchone()[0]
+        
+        # Join room
+        join_room(whiteboard_id)
+        
+        # Notify others
+        emit('user_joined', {
+            'user_id': user_id,
+            'username': username,
+            'timestamp': datetime.utcnow().isoformat()
+        }, room=whiteboard_id, include_self=False)
+    except Exception as e:
+        print(f"Error joining whiteboard: {e}")
+    finally:
+        cur.close()
+        conn.close()
+
+@socketio.on('add_element')
+def handle_add_element(data):
+    whiteboard_id = data.get('whiteboard_id')
+    element_type = data.get('type')
+    element_data = data.get('data')
+    user_id = session.get('user_id')
+    
+    if not all([whiteboard_id, element_type, element_data, user_id]):
+        return
+    
+    # Save to database
+    new_element = add_whiteboard_element(whiteboard_id, element_type, element_data, user_id)
+    if new_element:
+        # Broadcast to all in the whiteboard
+        emit('new_element', new_element, room=whiteboard_id)
+
+def create_whiteboard(name, user_id):
+    conn = get_db_connection()
+    cur = conn.cursor()
+    try:
+        whiteboard_id = str(uuid.uuid4())
+        cur.execute('''
+            INSERT INTO whiteboards (id, name, created_by)
+            VALUES (%s, %s, %s)
+            RETURNING id
+        ''', (whiteboard_id, name, user_id))
+        
+        # Add creator as participant
+        cur.execute('''
+            INSERT INTO whiteboard_participants (whiteboard_id, user_id)
+            VALUES (%s, %s)
+        ''', (whiteboard_id, user_id))
+        
+        conn.commit()
+        return whiteboard_id
+    except Exception as e:
+        conn.rollback()
+        print(f"Error creating whiteboard: {e}")
+        return None
+    finally:
+        cur.close()
+        conn.close()
+
+def get_whiteboard(whiteboard_id):
+    conn = get_db_connection()
+    cur = conn.cursor()
+    try:
+        cur.execute('''
+            SELECT w.id, w.name, u.username as created_by, w.created_at
+            FROM whiteboards w
+            JOIN users u ON w.created_by = u.id
+            WHERE w.id = %s
+        ''', (whiteboard_id,))
+        whiteboard = cur.fetchone()
+        
+        if not whiteboard:
+            return None
+            
+        cur.execute('''
+            SELECT type, data, created_at, u.username as created_by
+            FROM whiteboard_elements e
+            JOIN users u ON e.created_by = u.id
+            WHERE whiteboard_id = %s
+            ORDER BY created_at
+        ''', (whiteboard_id,))
+        elements = cur.fetchall()
+        
+        return {
+            'id': whiteboard[0],
+            'name': whiteboard[1],
+            'created_by': whiteboard[2],
+            'created_at': whiteboard[3],
+            'elements': [{
+                'type': e[0],
+                'data': e[1],
+                'created_at': e[2],
+                'created_by': e[3]
+            } for e in elements]
+        }
+    except Exception as e:
+        print(f"Error getting whiteboard: {e}")
+        return None
+    finally:
+        cur.close()
+        conn.close()
+
+def add_whiteboard_element(whiteboard_id, element_type, element_data, user_id):
+    conn = get_db_connection()
+    cur = conn.cursor()
+    try:
+        cur.execute('''
+            INSERT INTO whiteboard_elements (whiteboard_id, type, data, created_by)
+            VALUES (%s, %s, %s, %s)
+            RETURNING id, created_at
+        ''', (whiteboard_id, element_type, json.dumps(element_data), user_id))
+        
+        result = cur.fetchone()
+        conn.commit()
+        
+        # Get username for broadcasting
+        cur.execute('SELECT username FROM users WHERE id = %s', (user_id,))
+        username = cur.fetchone()[0]
+        
+        return {
+            'id': result[0],
+            'type': element_type,
+            'data': element_data,
+            'created_at': result[1],
+            'created_by': username
+        }
+    except Exception as e:
+        conn.rollback()
+        print(f"Error adding whiteboard element: {e}")
+        return None
+    finally:
+        cur.close()
+        conn.close()
+
 def get_unread_announcements_count(user_id):
     conn = get_db_connection()
     cur = conn.cursor()
@@ -2515,22 +2714,107 @@
     # GET request - show import form
     return render_template('admin/assignments/import.html')
 
+@app.route('/whiteboards')
+@login_required
+def list_whiteboards():
+    conn = get_db_connection()
+    cur = conn.cursor()
+    try:
+        # Get whiteboards the user has access to
+        cur.execute('''
+            SELECT w.id, w.name, u.username as created_by, w.created_at
+            FROM whiteboards w
+            JOIN users u ON w.created_by = u.id
+            JOIN whiteboard_participants p ON w.id = p.whiteboard_id
+            WHERE p.user_id = %s
+            ORDER BY w.created_at DESC
+        ''', (session['user_id'],))
+        
+        whiteboards = [{
+            'id': row[0],
+            'name': row[1],
+            'created_by': row[2],
+            'created_at': row[3]
+        } for row in cur.fetchall()]
+        
+        return render_template('whiteboards/list.html', whiteboards=whiteboards)
+    except Exception as e:
+        print(f"Error listing whiteboards: {e}")
+        return render_template('whiteboards/list.html', whiteboards=[])
+    finally:
+        cur.close()
+        conn.close()
+
+@app.route('/whiteboards/create', methods=['GET', 'POST'])
+@login_required
+def create_whiteboard_route():
+    form = CreateWhiteboardForm()
+    
+    if form.validate_on_submit():
+        name = form.name.data.strip()
+        whiteboard_id = create_whiteboard(name, session['user_id'])
+        if whiteboard_id:
+            flash('Whiteboard created successfully!', 'success')
+            return redirect(url_for('view_whiteboard', whiteboard_id=whiteboard_id))
+        else:
+            flash('Error creating whiteboard', 'danger')
+    
+    return render_template('whiteboards/create.html', form=form)
+
+@app.route('/whiteboards/<uuid:whiteboard_id>')
+@login_required
+def view_whiteboard(whiteboard_id):
+    whiteboard_id = str(whiteboard_id)
+    
+    # Check if user has access
+    conn = get_db_connection()
+    cur = conn.cursor()
+    try:
+        cur.execute('''
+            SELECT 1 FROM whiteboard_participants
+            WHERE whiteboard_id = %s AND user_id = %s
+        ''', (whiteboard_id, session['user_id']))
+        
+        if not cur.fetchone():
+            flash('You do not have access to this whiteboard', 'danger')
+            return redirect(url_for('list_whiteboards'))
+            
+        whiteboard = get_whiteboard(whiteboard_id)
+        if not whiteboard:
+            flash('Whiteboard not found', 'danger')
+            return redirect(url_for('list_whiteboards'))
+            
+        return render_template('whiteboards/view.html', 
+                            whiteboard=whiteboard,
+                            user_id=session['user_id'])
+    finally:
+        cur.close()
+        conn.close()
+
+@app.template_filter('datetime')
+def format_datetime(value, format="%Y-%m-%d %H:%M:%S"):
+    """Format a datetime object to a string."""
+    if value is None:
+        return ""
+    return value.strftime(format)
+
+
 @app.context_processor
 def inject_functions():
     return dict(get_unread_announcements_count=get_unread_announcements_count)
     
     
+# if __name__ == '__main__':
+#     from waitress import serve
 if __name__ == '__main__':
-    from waitress import serve
+    # Enable Flask debug features
+    app.debug = True  # Enables auto-reloader and debugger
+    
+    # Initialize database
     initialize_database()
-    serve(app, host="0.0.0.0", port=5000)
-
-# if __name__ == '__main__':
-#     # Enable Flask debug features
-#     app.debug = True  # Enables auto-reloader and debugger
     
-#     # Initialize database
-#     initialize_database()
+    # Run the development server with SocketIO
+    socketio.run(app, host='0.0.0.0', port=5000)
     
-#     # Run the development server
-#     app.run(host='0.0.0.0', port=5000)
+    # Run the development server
+    app.run(host='0.0.0.0', port=5000)
Index: requirements.txt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>Flask==2.3.2\r\npsycopg2-binary==2.9.6\r\ngunicorn==20.1.0\r\npython-dotenv==1.0.0\r\nflask\r\nflask_login\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/requirements.txt b/requirements.txt
--- a/requirements.txt	(revision bc58233865f924ee39b4e82a7e1e080720bdd4b5)
+++ b/requirements.txt	(date 1747816917797)
@@ -1,6 +1,117 @@
-Flask==2.3.2
-psycopg2-binary==2.9.6
-gunicorn==20.1.0
-python-dotenv==1.0.0
-flask
-flask_login
+anyio==4.9.0
+argon2-cffi==23.1.0
+argon2-cffi-bindings==21.2.0
+arrow==1.3.0
+asttokens==3.0.0
+async-lru==2.0.5
+attrs==25.3.0
+babel==2.17.0
+beautifulsoup4==4.13.4
+bidict==0.23.1
+bleach==6.2.0
+blinker==1.9.0
+certifi==2025.4.26
+cffi==1.17.1
+charset-normalizer==3.4.2
+click==8.1.8
+colorama==0.4.6
+comm==0.2.2
+debugpy==1.8.14
+decorator==5.2.1
+defusedxml==0.7.1
+docker==7.1.0
+ecdsa==0.19.1
+executing==2.2.0
+fastjsonschema==2.21.1
+Flask==3.1.0
+flask-cors==6.0.0
+Flask-Login==0.6.3
+Flask-SocketIO==5.5.1
+Flask-SQLAlchemy==3.1.1
+fqdn==1.5.1
+greenlet==3.2.1
+h11==0.16.0
+httpcore==1.0.9
+httpx==0.28.1
+idna==3.10
+ipykernel==6.29.5
+ipython==9.2.0
+ipython_pygments_lexers==1.1.1
+isoduration==20.11.0
+itsdangerous==2.2.0
+jedi==0.19.2
+Jinja2==3.1.6
+json5==0.12.0
+jsonpointer==3.0.0
+jsonschema==4.23.0
+jsonschema-specifications==2025.4.1
+jupyter-events==0.12.0
+jupyter-kernel-gateway==3.0.1
+jupyter-lsp==2.2.5
+jupyter_client==8.6.3
+jupyter_core==5.7.2
+jupyter_server==2.16.0
+jupyter_server_terminals==0.5.3
+jupyterlab==4.4.2
+jupyterlab_pygments==0.3.0
+jupyterlab_server==2.27.3
+MarkupSafe==3.0.2
+matplotlib-inline==0.1.7
+mistune==3.1.3
+nbclient==0.10.2
+nbconvert==7.16.6
+nbformat==5.10.4
+nest-asyncio==1.6.0
+notebook==7.4.2
+notebook_shim==0.2.4
+overrides==7.7.0
+packaging==25.0
+pandocfilters==1.5.1
+parso==0.8.4
+platformdirs==4.3.8
+prometheus_client==0.22.0
+prompt_toolkit==3.0.51
+psutil==7.0.0
+psycopg2-binary==2.9.10
+pure_eval==0.2.3
+pycparser==2.22
+Pygments==2.19.1
+python-dateutil==2.9.0.post0
+python-dotenv==1.1.0
+python-engineio==4.12.1
+python-http-client==3.3.7
+python-json-logger==3.3.0
+python-socketio==5.13.0
+pywin32==310
+pywinpty==2.0.15
+PyYAML==6.0.2
+pyzmq==26.4.0
+referencing==0.36.2
+requests==2.32.3
+rfc3339-validator==0.1.4
+rfc3986-validator==0.1.1
+rpds-py==0.25.0
+Send2Trash==1.8.3
+sendgrid==6.12.2
+setuptools==80.8.0
+simple-websocket==1.1.0
+six==1.17.0
+sniffio==1.3.1
+soupsieve==2.7
+SQLAlchemy==2.0.40
+stack-data==0.6.3
+terminado==0.18.1
+tinycss2==1.4.0
+tornado==6.5
+traitlets==5.14.3
+types-python-dateutil==2.9.0.20250516
+typing_extensions==4.13.2
+uri-template==1.3.0
+urllib3==2.4.0
+waitress==3.0.2
+wcwidth==0.2.13
+webcolors==24.11.1
+webencodings==0.5.1
+websocket-client==1.8.0
+Werkzeug==3.1.3
+wsproto==1.2.0
Index: templates/base.html
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><!DOCTYPE html>\r\n<html lang=\"en\">\r\n  <head>\r\n    <meta charset=\"UTF-8\" />\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\r\n    <title>MiltonTutor+ {% block title %}{% endblock %}</title>\r\n    <link\r\n      rel=\"stylesheet\"\r\n      href=\"{{ url_for('static', filename='css/style.css') }}\"\r\n    />\r\n    <link\r\n      href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css\"\r\n      rel=\"stylesheet\"\r\n    />\r\n    <link\r\n      href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css\"\r\n      rel=\"stylesheet\"\r\n    />\r\n    <link\r\n      rel=\"stylesheet\"\r\n      href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\"\r\n      integrity=\"sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==\"\r\n      crossorigin=\"anonymous\"\r\n      referrerpolicy=\"no-referrer\"\r\n    />\r\n    <link rel=\"stylesheet\" href=\"../static/css/video-tutorial.css\" />\r\n    <script src=\"../static/js/grade8/partsOfSpeech.js\" defer></script>\r\n    <script src=\"../static/js/grade7/fractions.js\" defer></script>\r\n    <script src=\"../static/js/grade8/algebraicExpressions.js\" defer></script>\r\n    <script src=\"../static/js/grade10/rational.js\" defer></script>\r\n    <script src=\"../static/js/video_tutorials.js\" defer></script>\r\n    <script src=\"../static/js/studyGuide.js\" defer></script>\r\n    <script src=\"../static/js/study_guides_interactive.js\" defer></script>\r\n  </head>\r\n\r\n  <body class=\"d-flex flex-column min-vh-100\">\r\n    <div class=\"wrapper\">\r\n      <nav class=\"navbar navbar-expand-lg navbar-dark bg-dark\">\r\n        <div class=\"container\">\r\n          <a\r\n            class=\"navbar-brand d-flex align-items-center\"\r\n            href=\"{{ url_for('home') }}\"\r\n          >\r\n            <i\r\n              class=\"bi bi-mortarboard-fill navbar-brand-icon text-white mx-2\"\r\n              style=\"font-size: 24px\"\r\n            ></i\r\n            ><span class=\"text-warning\">MiltonTutor</span\r\n            ><span class=\"fw-bolder text-white\">&plus;</span></a\r\n          >\r\n          <button\r\n            class=\"navbar-toggler position-relative\"\r\n            type=\"button\"\r\n            data-bs-toggle=\"collapse\"\r\n            data-bs-target=\"#navbarNav\"\r\n          >\r\n            <span class=\"navbar-toggler-icon\"></span>\r\n            <!-- Mobile badge (shown only when menu is closed) -->\r\n            {% if 'user_id' in session %} {% set unread_count =\r\n            get_unread_announcements_count(session['user_id']) %}\r\n            <span\r\n              id=\"mobileNotificationBadge\"\r\n              class=\"position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-lg-none\"\r\n              style=\"display: none\"\r\n            >\r\n              {{ unread_count }}\r\n            </span>\r\n            {% endif %}\r\n          </button>\r\n          <div class=\"collapse navbar-collapse\" id=\"navbarNav\">\r\n            <ul class=\"navbar-nav me-auto\">\r\n              <li class=\"nav-item\" style=\"font-size: 0.9rem\">\r\n                <a class=\"nav-link\" href=\"{{ url_for('home') }}\">\r\n                  <i class=\"bi bi-house-door-fill me-1\"></i>\r\n                  <span>Home</span></a\r\n                >\r\n              </li>\r\n              {% if 'username' in session and session.role == 'student' %}\r\n              <li class=\"nav-item\" style=\"font-size: 0.9rem\">\r\n                <a class=\"nav-link\" href=\"{{ url_for('view_sessions') }}\">\r\n                  <i class=\"bi bi-calendar-event me-1\"></i>\r\n                  <span>Book A Class</span></a\r\n                >\r\n              </li>\r\n              <li class=\"nav-item\" style=\"font-size: 0.9rem\">\r\n                <a class=\"nav-link\" href=\"{{ url_for('view_assignments') }}\">\r\n                  <i class=\"bi bi-journal-text me-1\"></i>\r\n                  <span>Assignments</span>\r\n                </a>\r\n              </li>\r\n              <li class=\"nav-item\" style=\"font-size: 0.9rem\">\r\n                <a class=\"nav-link\" href=\"{{ url_for('view_submissions') }}\">\r\n                  <i class=\"bi bi-list-check me-1\"></i>\r\n                  <span>My Work</span>\r\n                </a>\r\n              </li>\r\n              <li class=\"nav-item\" style=\"font-size: 0.9rem\">\r\n                <a class=\"nav-link\" href=\"{{ url_for('tutorials_home') }}\">\r\n                  <i class=\"bi bi-collection-play me-1\"></i>\r\n                  <span>Tutorials</span>\r\n                </a>\r\n              </li>\r\n              <li class=\"nav-item\" style=\"font-size: 0.9rem\">\r\n                <a class=\"nav-link\" href=\"{{ url_for('studyguides_home') }}\">\r\n                  <i class=\"bi bi-book me-1\"></i> <span>Practice</span>\r\n                </a>\r\n              </li>\r\n              {# Add the Exam Practice link here #}\r\n              <li class=\"nav-item\" style=\"font-size: 0.9rem\">\r\n                <a class=\"nav-link\" href=\"{{ url_for('exam_practice') }}\">\r\n                  <i class=\"bi bi-pencil-square me-1\"></i>\r\n                  <span>Exams</span>\r\n                </a>\r\n              </li>\r\n              <li class=\"nav-item\" style=\"font-size: 0.9rem\">\r\n                <a class=\"nav-link\" href=\"{{ url_for('view_leaderboard') }}\">\r\n                  <i class=\"bi bi-trophy-fill\"></i>\r\n                  <span>Leaderboard</span>\r\n                </a>\r\n              </li>\r\n              {% if 'user_id' in session %}\r\n              <!-- Later in your navbar items -->\r\n              <li class=\"nav-item\" style=\"font-size: 0.9rem\">\r\n                <a class=\"nav-link\" href=\"{{ url_for('view_announcements') }}\">\r\n                  <i class=\"bi bi-megaphone\"></i>\r\n                  <span>Announcements</span>\r\n                  <!-- Desktop badge (always shown) -->\r\n                  {% if 'user_id' in session %} {% set unread_count =\r\n                  get_unread_announcements_count(session['user_id']) %} {% if\r\n                  unread_count > 0 %}\r\n                  <span\r\n                    id=\"desktopNotificationBadge\"\r\n                    class=\"badge bg-danger d-none d-lg-inline-block\"\r\n                    >{{ unread_count }}</span\r\n                  >\r\n                  {% endif %} {% endif %}\r\n                  <!-- Mobile badge (shown only when menu is open) -->\r\n                  <span\r\n                    id=\"mobileMenuOpenBadge\"\r\n                    class=\"badge bg-danger d-lg-none\"\r\n                    style=\"display: none\"\r\n                    >{{ unread_count }}</span\r\n                  >\r\n                </a>\r\n              </li>\r\n              {% endif %} {% endif %} {% if 'username' in session %} {% endif %}\r\n            </ul>\r\n            <ul class=\"navbar-nav\">\r\n              {% if 'username' in session and session['role'] == 'admin' %}\r\n              <li class=\"nav-item\">\r\n                <a\r\n                  class=\"nav-link btn btn-outline-warning btn-sm mx-2\"\r\n                  href=\"{{ url_for('admin_dashboard') }}\"\r\n                >\r\n                  <i class=\"bi bi-speedometer2 me-1\"></i> Admin Panel\r\n                </a>\r\n              </li>\r\n              {% endif %} {% if 'username' in session %}\r\n              <li class=\"nav-item dropdown\">\r\n                <a\r\n                  class=\"nav-link dropdown-toggle\"\r\n                  href=\"#\"\r\n                  id=\"userDropdown\"\r\n                  role=\"button\"\r\n                  data-bs-toggle=\"dropdown\"\r\n                >\r\n                  <i class=\"bi bi-person-circle me-1\"></i> {{\r\n                  session['username'] }}\r\n                </a>\r\n                <ul\r\n                  class=\"dropdown-menu dropdown-menu-end\"\r\n                  aria-labelledby=\"userDropdown\"\r\n                >\r\n                  <li>\r\n                    <a class=\"dropdown-item\" href=\"#\"\r\n                      ><i class=\"bi bi-person me-2\"></i> Profile</a\r\n                    >\r\n                  </li>\r\n                  {# Add this link for students #} {% if session.get('role') ==\r\n                  'student' %}\r\n                  <li>\r\n                    <a\r\n                      class=\"dropdown-item\"\r\n                      href=\"{{ url_for('subscription_status') }}\"\r\n                    >\r\n                      <i class=\"bi bi-credit-card me-2\"></i> Subscription Status\r\n                    </a>\r\n                  </li>\r\n                  {% endif %}\r\n                  <li>\r\n                    <hr class=\"dropdown-divider\" />\r\n                  </li>\r\n                  <li>\r\n                    <a class=\"dropdown-item\" href=\"{{ url_for('logout') }}\"\r\n                      ><i class=\"bi bi-box-arrow-right me-2\"></i> Logout</a\r\n                    >\r\n                  </li>\r\n                </ul>\r\n              </li>\r\n              {% else %}\r\n              <li class=\"nav-item\">\r\n                <a class=\"nav-link\" href=\"{{ url_for('login') }}\">Login</a>\r\n              </li>\r\n              {% endif %}\r\n            </ul>\r\n          </div>\r\n        </div>\r\n      </nav>\r\n\r\n      <div class=\"container flex-grow-1 m-auto\" style=\"padding: 0\">\r\n        {% with messages = get_flashed_messages(with_categories=true) %} {% if\r\n        messages %} {% for category, message in messages %}\r\n        <div class=\"alert alert-{{ category }} alert-dismissible fade show\">\r\n          {{ message }}\r\n          <button\r\n            type=\"button\"\r\n            class=\"btn-close\"\r\n            data-bs-dismiss=\"alert\"\r\n          ></button>\r\n        </div>\r\n        {% endfor %} {% endif %} {% endwith %} {% block content %}{% endblock %}\r\n      </div>\r\n\r\n      <footer class=\"bg-dark text-white mt-5 py-2\">\r\n        <div class=\"container py-4\">\r\n          <div class=\"row g-4\">\r\n            <div class=\"col-lg-3\">\r\n              <h3 class=\"h5 text-white mb-4\">MiltonTutor +</h3>\r\n              <p class=\"text-white-50\">\r\n                Helping students succeed since 2015 with premium exam\r\n                preparation materials.\r\n              </p>\r\n            </div>\r\n\r\n            <div class=\"col-6 col-lg-2\">\r\n              <h3 class=\"h5 text-white mb-4\">Resources</h3>\r\n              <ul class=\"list-unstyled\">\r\n                <li class=\"mb-2\">\r\n                  <a href=\"#\" class=\"text-white-50\">Study Guides</a>\r\n                </li>\r\n                <li class=\"mb-2\">\r\n                  <a href=\"#\" class=\"text-white-50\">Video Library</a>\r\n                </li>\r\n                <li class=\"mb-2\">\r\n                  <a href=\"#\" class=\"text-white-50\">Practice Tests</a>\r\n                </li>\r\n              </ul>\r\n            </div>\r\n\r\n            <div class=\"col-6 col-lg-2\">\r\n              <h3 class=\"h5 text-white mb-4\">Company</h3>\r\n              <ul class=\"list-unstyled\">\r\n                <li class=\"mb-2\">\r\n                  <a href=\"#\" class=\"text-white-50\">About Us</a>\r\n                </li>\r\n                <li class=\"mb-2\">\r\n                  <a href=\"#\" class=\"text-white-50\">Our Educators</a>\r\n                </li>\r\n                <li class=\"mb-2\">\r\n                  <a href=\"#\" class=\"text-white-50\">Careers</a>\r\n                </li>\r\n              </ul>\r\n            </div>\r\n\r\n            <div class=\"col-lg-3\">\r\n              <h3 class=\"h5 text-white mb-4\">Contact</h3>\r\n              <p class=\"text-white-50\">support@studymasterpro.com</p>\r\n              <p class=\"text-white-50\">1-800-555-EDUC</p>\r\n            </div>\r\n          </div>\r\n\r\n          <hr class=\"my-4 bg-secondary\" />\r\n\r\n          <div\r\n            class=\"d-flex flex-column flex-md-row justify-content-between align-items-center\"\r\n          >\r\n            <p class=\"small text-white-50 mb-2 mb-md-0\">\r\n              &copy; 2025 MiltonTutor+. All rights reserved.\r\n            </p>\r\n            <div class=\"d-flex\">\r\n              <a href=\"#\" class=\"text-white-50 small me-3\">Terms</a>\r\n              <a href=\"#\" class=\"text-white-50 small me-3\">Privacy</a>\r\n              <a href=\"#\" class=\"text-white-50 small\">Cookies</a>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </footer>\r\n    </div>\r\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\r\n\r\n    {% block scripts %}{% endblock %}\r\n    <script>\r\n      document.addEventListener(\"DOMContentLoaded\", function () {\r\n        const navbarCollapse = document.getElementById(\"navbarNav\");\r\n        const mobileBadge = document.getElementById(\"mobileNotificationBadge\");\r\n        const menuOpenBadge = document.getElementById(\"mobileMenuOpenBadge\");\r\n\r\n        if (navbarCollapse && mobileBadge && menuOpenBadge) {\r\n          // Initialize based on current state\r\n          if (navbarCollapse.classList.contains(\"show\")) {\r\n            menuOpenBadge.style.display = \"inline-block\";\r\n            mobileBadge.style.display = \"none\";\r\n          } else {\r\n            menuOpenBadge.style.display = \"none\";\r\n            mobileBadge.style.display = \"inline-block\";\r\n          }\r\n\r\n          // Handle collapse events\r\n          navbarCollapse.addEventListener(\"show.bs.collapse\", function () {\r\n            menuOpenBadge.style.display = \"inline-block\";\r\n            mobileBadge.style.display = \"none\";\r\n          });\r\n\r\n          navbarCollapse.addEventListener(\"hide.bs.collapse\", function () {\r\n            menuOpenBadge.style.display = \"none\";\r\n            mobileBadge.style.display = \"inline-block\";\r\n          });\r\n        }\r\n      });\r\n    </script>\r\n  </body>\r\n</html>\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/templates/base.html b/templates/base.html
--- a/templates/base.html	(revision bc58233865f924ee39b4e82a7e1e080720bdd4b5)
+++ b/templates/base.html	(date 1747836956774)
@@ -23,6 +23,14 @@
       crossorigin="anonymous"
       referrerpolicy="no-referrer"
     />
+    <!-- Add these to your base template if not already present -->
+    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
+    <script src="https://cdn.jsdelivr.net/npm/fabric@5.2.4/dist/fabric.min.js"></script>
+    <script
+      id="MathJax-script"
+      async
+      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
+    ></script>
     <link rel="stylesheet" href="../static/css/video-tutorial.css" />
     <script src="../static/js/grade8/partsOfSpeech.js" defer></script>
     <script src="../static/js/grade7/fractions.js" defer></script>
@@ -110,6 +118,12 @@
                 <a class="nav-link" href="{{ url_for('exam_practice') }}">
                   <i class="bi bi-pencil-square me-1"></i>
                   <span>Exams</span>
+                </a>
+              </li>
+              <li class="nav-item" style="font-size: 0.9rem">
+                <a class="nav-link" href="{{ url_for('list_whiteboards') }}">
+                  <i class="bi bi-easel me-1"></i>
+                  <span>Whiteboard</span>
                 </a>
               </li>
               <li class="nav-item" style="font-size: 0.9rem">
